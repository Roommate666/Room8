<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mein Profil - Room8</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .verified-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background-color: #3b82f6;
            border-radius: 50%;
            margin-left: 0.5rem;
            position: relative;
        }
        .verified-badge svg {
            width: 14px;
            height: 14px;
            stroke: white;
            stroke-width: 3;
        }
        
        /* Feature Highlight Banner */
        .feature-banner {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 1.5rem;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .feature-banner::before {
            content: '';
            position: absolute;
            font-size: 6rem;
            opacity: 0.1;
            right: -1rem;
            top: -1rem;
        }

        .feature-banner-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .feature-icon {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .feature-banner h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .feature-banner p {
            margin: 0 0 1rem 0;
            font-size: 0.95rem;
            line-height: 1.5;
            opacity: 0.95;
        }

        .feature-list {
            list-style: none;
            padding: 0;
            margin: 0 0 1rem 0;
        }

        .feature-list li {
            padding: 0.2rem 0;
            padding-left: 1.5rem;
            position: relative;
            font-size: 0.9rem;
        }

        .feature-list li::before {
            content: '✓';
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        .feature-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .feature-btn {
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: inline-block;
        }

        .feature-btn-primary {
            background: white;
            color: #059669;
        }

        .feature-btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .close-banner {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        /* CUSTOM MODAL (Ersatz für confirm/alert) */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            padding: 1rem;
        }
        
        .modal-box {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .modal-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 0.5rem; }
        .modal-text { color: var(--text-muted); margin-bottom: 1.5rem; }
        
        .modal-actions { display: flex; gap: 1rem; justify-content: center; }
        .modal-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 99px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            flex: 1;
        }
        .btn-cancel { background: #F3F4F6; color: var(--text-main); }
        .btn-confirm { background: #EF4444; color: white; }
    </style>
</head>
<body>

<div class="app-container">
    <header class="app-header" style="display: flex; align-items: center; justify-content: space-between; gap: 0.5rem;">
        <h1 data-i18n="profile_title" style="margin: 0; flex-shrink: 0; font-size: 1.25rem; color: #667eea;">Mein Profil</h1>
        <div style="display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0;">
            <!-- Notification Bell -->
            <a href="notifications.html" title="Benachrichtigungen" style="position: relative; display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; background: white; border-radius: 50%; color: #667eea; text-decoration: none; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/>
                    <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>
                </svg>
                <span id="notificationBadge" style="display:none; position:absolute; top:-2px; right:-2px; background:#ef4444; color:white; border-radius:50%; min-width:16px; height:16px; font-size:0.6rem; font-weight:bold; align-items:center; justify-content:center; padding: 0 4px;"></span>
            </a>
            <!-- Settings -->
            <a href="settings.html" title="Einstellungen" style="display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; background: white; border-radius: 50%; color: #667eea; text-decoration: none; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </a>
            <!-- New Listing -->
            <a href="choose-listing.html" data-i18n="profile_new_listing" style="white-space: nowrap; padding: 0.5rem 0.75rem; background: white; color: #667eea; border-radius: 18px; font-weight: 700; font-size: 0.8rem; text-decoration: none; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">+ Inserat</a>
        </div>
    </header>

    <!-- Profil-Begrüßung -->
    <div class="profile-greeting">
        <a href="#" id="public-profile-link-avatar">
            <div id="avatar-container" class="avatar-display">
                <img src="placeholder.png" alt="Avatar" id="avatar-img" onerror="this.src='https://via.placeholder.com/100?text=User'">
            </div>
        </a>
        <div class="greeting-text">
            <h2 id="welcome-message" style="display: flex; align-items: center;">
                Hallo, ...!
                <span id="verified-badge" style="display: none;" class="verified-badge">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </span>
            </h2>
            <div class="profile-actions">
                <a href="edit-profile.html" class="profile-btn" data-i18n="profile_edit">Profil bearbeiten</a>
                <a href="#" id="public-profile-link-text" class="profile-btn secondary" data-i18n="profile_public">Öffentliches Profil</a>
            </div>
        </div>
    </div>

    <!-- NEUE FEATURES BANNER -->
    <div class="feature-banner" id="featureBanner" style="display: none;">
        <button class="close-banner" onclick="closeBanner()">&#215;</button>
        <div class="feature-banner-header">
            <div class="feature-icon">&#127881;</div>
            <h3 data-i18n="profile_new_features">Neu bei Room8!</h3>
        </div>
        <p data-i18n="profile_new_features_desc">Entdecke die neuen Möglichkeiten:</p>
        <ul class="feature-list">
            <li data-i18n="profile_feature_1">Personalisierte Benachrichtigungen</li>
            <li data-i18n="profile_feature_2">Gespeicherte Suchen</li>
            <li data-i18n="profile_feature_3">Verifizierung für mehr Vertrauen</li>
        </ul>
        <div class="feature-buttons">
            <a href="verify-options.html" class="feature-btn feature-btn-primary" data-i18n="profile_setup_now">Verifizieren</a>
            <a href="saved-searches.html" class="feature-btn feature-btn-secondary" data-i18n="profile_save_search">Suchen</a>
        </div>
    </div>

    <!-- FAVORITES LINK -->
    <div style="padding: 1rem 1.5rem; background-color: white; border-bottom: 1px solid var(--border-color);">
        <a href="favorites.html" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border-radius: 12px; text-decoration: none; color: #991b1b; border: 2px solid #fecaca; transition: all 0.2s;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div style="width: 48px; height: 48px; background-color: #ef4444; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                    </svg>
                </div>
                <div>
                    <h4 style="margin: 0; font-size: 1.1rem; color: #7f1d1d;" data-i18n="profile_favorites">Meine Favoriten</h4>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #991b1b;" data-i18n="profile_favorites_desc">Gespeicherte Inserate ansehen</p>
                </div>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
        </a>
    </div>

    <main class="app-content" style="padding: 0;">
        <div class="my-listings-header">
            <h3><span data-i18n="profile_my_listings">Meine Inserate</span> <span id="listing-count"></span></h3>
        </div>
        <div id="my-listings-container" class="listings-grid">
            <p style="padding: 1.5rem; color: var(--text-muted);">Lade Inserate...</p>
        </div>
    </main>

    <div id="app-footer-nav"></div>
</div>

<!-- Custom Modal für Lösch-Bestätigung (AUSSERHALB app-container für korrektes z-index) -->
<div id="deleteModal" class="modal-overlay">
    <div class="modal-box">
        <h3 class="modal-title">Inserat löschen?</h3>
        <p class="modal-text">Dies kann nicht rückgängig gemacht werden.</p>
        <div class="modal-actions">
            <button class="modal-btn btn-cancel" onclick="closeDeleteModal()">Abbrechen</button>
            <button class="modal-btn btn-confirm" id="confirmDeleteBtn">Löschen</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.14"></script>
<script src="config.js"></script>
<script src="room8-ui.js"></script>
<script src="navigation.js"></script>
<script src="translations.js"></script>
<script src="room8-utils.js"></script>
<script>
    // Supabase Client - Direkte Initialisierung
    var sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Helper: Navigation
    function navigateTo(url) {
        try { window.location.href = url; } catch(e) { console.warn(e); }
    }

    // XSS Protection
    function escapeHtml(text) {
        if (text === null || text === undefined) return '';
        return String(text).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    var listingsContainer = document.getElementById('my-listings-container');
    var welcomeMessage = document.getElementById('welcome-message');
    var avatarImg = document.getElementById('avatar-img');
    var listingCount = document.getElementById('listing-count');
    var verifiedBadge = document.getElementById('verified-badge');
    var publicProfileLinkAvatar = document.getElementById('public-profile-link-avatar');
    var publicProfileLinkText = document.getElementById('public-profile-link-text');
    
    // Modal Variables
    var deleteModal = document.getElementById('deleteModal');
    var confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    var listingToDelete = null;
    var cardToDelete = null;

    async function initProfile() {
        if (!sb) return;

        const { data: { user } } = await sb.auth.getUser();
        if (!user) {
            navigateTo('login.html');
            return;
        }

        loadProfileData(user.id);
        checkFeatureBanner(user.id);
        updateNotificationBadge(user.id);
    }

    async function loadProfileData(userId) {
        // Profil
        const { data: profile } = await sb.from('profiles').select('*').eq('id', userId).single();
        if (profile) {
            var username = profile.username || 'User';
            welcomeMessage.childNodes[0].textContent = 'Hallo, ' + username + '! ';
            
            if (profile.avatar_url) avatarImg.src = profile.avatar_url;
            if (profile.is_verified || profile.is_student_verified) verifiedBadge.style.display = 'inline-flex';

            publicProfileLinkAvatar.onclick = () => navigateTo('public-profile.html?id=' + userId);
            publicProfileLinkText.onclick = () => navigateTo('public-profile.html?id=' + userId);
        }

        // Inserate
        console.log("Loading listings for user:", userId);
        const { data: listings, error } = await sb
            .from('listings')
            .select('id, title, city, type, view_count, listing_photos(storage_path)')
            .eq('owner_id', userId)
            .eq('is_active', true);

        if (error) {
            console.error("Error loading listings:", error);
            listingsContainer.innerHTML = '<p style="padding:1.5rem; color:red;">Fehler beim Laden: ' + error.message + '</p>';
            return;
        }

        listingsContainer.innerHTML = '';
        if (listings && listings.length > 0) {
            listingCount.textContent = '(' + listings.length + ')';
            listings.forEach(function(listing) {
                var card = createListingCard(listing);
                if (card) listingsContainer.appendChild(card);
            });
        } else {
            listingCount.textContent = '(0)';
            listingsContainer.innerHTML = `
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line>
                    </svg>
                    <h3>Noch keine Inserate</h3>
                    <p>Erstelle dein erstes Inserat!</p>
                    <a href="choose-listing.html" class="submit-btn" style="width:auto; display:inline-block;">+ Erstes Inserat erstellen</a>
                </div>`;
        }
    }

    function createListingCard(listing) {
        // Skip listings ohne gültige ID
        if (!listing || !listing.id) {
            console.warn("Listing ohne ID übersprungen:", listing);
            return null;
        }
        console.log("Creating card for listing:", listing.id, listing.title);
        var card = document.createElement('div');
        card.className = 'listing-card';
        card.dataset.listingId = String(listing.id); // ID als String speichern
        
        var imageUrl = 'https://via.placeholder.com/300x200?text=Room8';
        if (listing.listing_photos && listing.listing_photos.length > 0) {
            var urlData = sb.storage.from('listing-images').getPublicUrl(listing.listing_photos[0].storage_path);
            if (urlData.data) imageUrl = urlData.data.publicUrl;
        }
        
        var editPage = listing.type === 'wohnung' ? 'wohnung.html' : 'gegenstand.html';
        var editUrl = editPage + '?id=' + listing.id;
        
        card.innerHTML = `
            <a href="javascript:void(0)" onclick="navigateTo('detail.html?id=${listing.id}')" class="card-image-link">
                <img src="${imageUrl}" alt="${escapeHtml(listing.title)}">
            </a>
            <div class="card-content">
                <h4>${escapeHtml(listing.title)}</h4>
                <p class="card-meta">${escapeHtml(listing.city) || 'N/A'} - ${escapeHtml(listing.type)}</p>
                <div class="card-actions">
                    <button class="btn-small btn-edit" onclick="navigateTo('${editUrl}')">Bearbeiten</button>
                    <button class="btn-small btn-delete">Löschen</button>
                </div>
            </div>`;
        
        card.querySelector('.btn-delete').addEventListener('click', function(e) {
            e.stopPropagation();
            var id = card.dataset.listingId;
            console.log("Delete button clicked, ID from data-attr:", id);
            openDeleteModal(id, card);
        });
        
        return card;
    }

    // Modal Logic
    function openDeleteModal(id, card) {
        console.log("Delete ID:", id, typeof id);
        if (!id || id === 'null' || id === 'undefined') {
            Room8UI.error("Ungültige Inserat-ID");
            return;
        }
        listingToDelete = id;
        cardToDelete = card;
        deleteModal.style.display = 'flex';
    }

    window.closeDeleteModal = function() {
        deleteModal.style.display = 'none';
        listingToDelete = null;
        cardToDelete = null;
    }

    confirmDeleteBtn.onclick = async function() {
        if (!listingToDelete || listingToDelete === 'null' || listingToDelete === 'undefined') {
            Room8UI.error("Keine gültige Inserat-ID");
            closeDeleteModal();
            return;
        }

        // ID und Card LOKAL speichern bevor closeDeleteModal sie nullt
        var idToDelete = listingToDelete;
        var cardToRemove = cardToDelete;

        // Modal schließen
        closeDeleteModal();

        // Optimistisch entfernen
        cardToRemove.style.opacity = '0.5';

        console.log("Deleting listing with ID:", idToDelete);
        const { error } = await sb.from('listings').delete().eq('id', idToDelete);

        if (error) {
            console.error("Delete error:", error);
            Room8UI.error("Fehler: " + error.message);
            cardToRemove.style.opacity = '1';
        } else {
            cardToRemove.remove();
            Room8UI.success("Inserat gelöscht!");
            // Count update (quick fix regex)
            var count = parseInt(listingCount.textContent.replace(/\D/g,'')) - 1;
            listingCount.textContent = '(' + Math.max(0, count) + ')';
        }
    };

    // Feature Banner
    function checkFeatureBanner(userId) {
        var bannerSeen = localStorage.getItem('feature_banner_seen_' + userId);
        if (!bannerSeen) {
            setTimeout(() => { document.getElementById('featureBanner').style.display = 'block'; }, 500);
        }
    }

    window.closeBanner = function() {
        sb.auth.getUser().then(({data}) => {
            if(data.user) localStorage.setItem('feature_banner_seen_' + data.user.id, 'true');
        });
        document.getElementById('featureBanner').style.display = 'none';
    };

    // Badge update
    async function updateNotificationBadge(userId) {
        const { count } = await sb
            .from('notifications')
            .select('*', { count: 'exact', head: true })
            .eq('user_id', userId)
            .eq('is_read', false);
        
        const badge = document.getElementById('notificationBadge');
        if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.style.display = 'flex';
        }
    }

    document.addEventListener('DOMContentLoaded', initProfile);
</script>
</body>
</html>