<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Job erstellen - Admin</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .app-header { background: #111827; color: white; }
    </style>
</head>
<body>
<div class="app-container">
    <header class="app-header">
        <a href="admin-panel.html" class="back-arrow" style="color:white;">&#8592;</a>
        <h1>Job erstellen</h1>
    </header>

    <main class="app-content">
        <form id="createJobForm">
            <!-- Logo -->
            <div class="form-group">
                <label>Firmenlogo</label>
                <div class="upload-area" onclick="document.getElementById('logoInput').click()" style="padding: 1rem;">
                    <div id="previewContainer">Klicken zum Hochladen</div>
                </div>
                <input type="file" id="logoInput" accept="image/*" style="display:none">
            </div>

            <!-- Basics -->
            <div class="form-group">
                <label>Job Titel</label>
                <input type="text" id="title" required placeholder="z.B. Werkstudent IT">
            </div>
            <div class="form-group">
                <label>Firmenname</label>
                <input type="text" id="company" required placeholder="Firma GmbH">
            </div>
            <div class="form-group">
                <label>Webseite</label>
                <input type="url" id="website" placeholder="https://...">
            </div>
            <div class="form-group">
                <label>Standort</label>
                <input type="text" id="location" required placeholder="Stadt / Remote">
            </div>
            <div class="form-group">
                <label>Firmengröße</label>
                <select id="companySize">
                    <option value="startup">Startup</option>
                    <option value="mittelstand">Mittelstand</option>
                    <option value="konzern">Konzern</option>
                </select>
            </div>

            <!-- Details -->
            <div class="form-group">
                <label>Typ</label>
                <select id="jobType">
                    <option value="werkstudent">Werkstudent</option>
                    <option value="minijob">Minijob</option>
                    <option value="praktikum">Praktikum</option>
                    <option value="festanstellung">Festanstellung</option>
                </select>
            </div>
            <div class="form-group">
                <label>Dauer</label>
                <select id="contractDuration">
                    <option value="unbefristet">Unbefristet</option>
                    <option value="befristet">Befristet</option>
                </select>
            </div>

            <!-- Gehalt -->
            <div class="form-group">
                <label>Gehalt</label>
                <div style="display:flex; gap:0.5rem;">
                    <input type="number" id="salaryAmount" placeholder="Betrag" step="0.01">
                    <select id="salaryType">
                        <option value="per_hour">pro Std</option>
                        <option value="per_month">pro Monat</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>Wochenstunden</label>
                <div style="display:flex; gap:0.5rem;">
                    <input type="number" id="minHours" placeholder="Min">
                    <input type="number" id="maxHours" placeholder="Max">
                </div>
            </div>

            <!-- Text -->
            <div class="form-group">
                <label>Beschreibung</label>
                <textarea id="description" rows="5" required></textarea>
            </div>
            <div class="form-group">
                <label>Anforderungen (eine pro Zeile)</label>
                <textarea id="requirements" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>Benefits (eins pro Zeile)</label>
                <textarea id="benefits" rows="3"></textarea>
            </div>
            
            <!-- Apply -->
            <div class="form-group">
                <label>Bewerbungs-Email</label>
                <input type="email" id="appEmail">
            </div>
            <div class="form-group">
                <label>Bewerbungs-Link</label>
                <input type="url" id="appUrl">
            </div>

            <div class="form-group" style="display:flex; gap:0.5rem; align-items:center;">
                <input type="checkbox" id="isDemo" style="width:auto;">
                <label for="isDemo" style="margin:0;">Als Demo markieren</label>
            </div>

            <button type="submit" class="submit-btn" style="background:#111827;">Job Veröffentlichen</button>
        </form>
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>
<script>
    if (typeof SUPABASE_URL === 'undefined') { var SUPABASE_URL = 'https://tvnvmogaqmduzcycmvby.supabase.co'; var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2bnZtb2dhcW1kdXpjeWNtdmJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NTA4MTksImV4cCI6MjA3MDUyNjgxOX0.MuLv9AdclVVZYZpUFv6Bc2Jn1Z9cmmcarHwBHlHkvZw'; }
    var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const ADMIN_EMAIL = 'albayrak_yusuf@icloud.com';

    function navigateTo(url) {
        try { window.location.href = url; } catch(e) { console.warn("Nav Error:", e); }
    }

    async function checkAdmin() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user || user.email !== ADMIN_EMAIL) { navigateTo('dashboard.html'); }
        return user;
    }

    // Preview
    const fileInput = document.getElementById('logoInput');
    fileInput.addEventListener('change', (e) => {
        if(e.target.files[0]) document.getElementById('previewContainer').innerHTML = `✅ ${e.target.files[0].name}`;
    });

    function textToArray(text) { return text.split('\n').filter(line => line.trim() !== ''); }

    document.getElementById('createJobForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const user = await checkAdmin();
        const btn = e.target.querySelector('button');
        btn.textContent = 'Speichere...'; btn.disabled = true;

        try {
            const jobData = {
                owner_id: user.id,
                type: 'job',
                title: document.getElementById('title').value,
                company_name: document.getElementById('company').value,
                company_website: document.getElementById('website').value,
                company_size: document.getElementById('companySize').value,
                location: document.getElementById('location').value,
                city: document.getElementById('location').value.split('/')[0].trim(),
                job_type: document.getElementById('jobType').value,
                contract_duration: document.getElementById('contractDuration').value,
                salary_amount: document.getElementById('salaryAmount').value,
                salary_type: document.getElementById('salaryType').value,
                min_hours_per_week: document.getElementById('minHours').value,
                max_hours_per_week: document.getElementById('maxHours').value,
                description: document.getElementById('description').value,
                requirements: textToArray(document.getElementById('requirements').value),
                benefits: textToArray(document.getElementById('benefits').value),
                application_email: document.getElementById('appEmail').value,
                application_url: document.getElementById('appUrl').value,
                is_demo: document.getElementById('isDemo').checked,
                is_active: true
            };

            const { data: job, error } = await supabase.from('listings').insert(jobData).select().single();
            if (error) throw error;

            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const path = `jobs/${job.id}_logo.${file.name.split('.').pop()}`;
                await supabase.storage.from('listing-images').upload(path, file);
                await supabase.from('listing_photos').insert({ listing_id: job.id, storage_path: path });
            }

            alert("Job erstellt!");
            navigateTo("admin-panel.html");
        } catch (err) {
            alert("Fehler: " + err.message);
            btn.disabled = false;
        }
    });

    checkAdmin();
</script>
</body>
</html>