<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Profil - Room8</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* PROFILE HEADER CARD */
        .profile-header-card {
            background: white;
            border-radius: var(--radius-md);
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            position: relative;
        }

        .profile-avatar-large {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: #EEF2FF;
            color: var(--primary-color);
            font-size: 2.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem auto;
            background-size: cover;
            background-position: center;
            border: 4px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .profile-name {
            font-size: 1.4rem;
            font-weight: 700;
            margin: 0 0 0.25rem 0;
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .profile-meta {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        /* BADGES */
        .badge-container {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-verified { background: #ECFDF5; color: #059669; border: 1px solid #A7F3D0; }
        .badge-student { background: #EFF6FF; color: #1D4ED8; border: 1px solid #BFDBFE; }

        /* ACTION BUTTONS */
        .profile-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn-message {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 0.7rem 2rem;
            border-radius: 99px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-glow);
            transition: transform 0.1s;
        }
        .btn-message:active { transform: scale(0.95); }

        .btn-report {
            background: white;
            color: var(--text-muted);
            border: 1px solid var(--border-color);
            padding: 0.7rem;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .btn-report:hover { background: #FEF2F2; color: #EF4444; border-color: #EF4444; }

        /* TABS */
        .profile-tabs {
            display: flex;
            background: #F3F4F6;
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .tab-btn {
            flex: 1;
            padding: 0.7rem;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 10px;
            color: var(--text-muted);
            transition: all 0.2s;
            background: transparent;
            border: none;
        }

        .tab-btn.active {
            background: white;
            color: var(--text-main);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* INFO GRID */
        .info-section {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
        }
        .info-section h3 { margin: 0 0 1rem 0; font-size: 1rem; color: var(--text-main); }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        .info-item { display: flex; flex-direction: column; }
        .info-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 2px; }
        .info-value { font-size: 0.95rem; font-weight: 500; color: var(--text-main); }

        /* TAGS */
        .tags-container { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .tag {
            padding: 0.4rem 0.8rem;
            background-color: #F3F4F6;
            border: 1px solid #E5E7EB;
            border-radius: 99px;
            font-size: 0.85rem;
            color: var(--text-main);
        }

        /* LISTINGS GRID */
        .mini-listings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
        }

        .mini-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .mini-card-img {
            height: 100px;
            width: 100%;
            object-fit: cover;
            background: #F3F4F6;
        }

        .mini-card-body { padding: 0.75rem; }
        .mini-card-title {
            font-size: 0.85rem; font-weight: 600; margin: 0 0 0.25rem 0;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .mini-card-price { font-size: 0.85rem; color: var(--primary-color); font-weight: 700; }

        /* REVIEWS */
        .review-item {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }
        .review-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .review-author { font-weight: 600; font-size: 0.9rem; }
        .review-date { font-size: 0.8rem; color: var(--text-muted); }
        .review-stars { color: #F59E0B; font-size: 0.9rem; }
        .review-text { font-size: 0.9rem; color: #4B5563; line-height: 1.4; margin: 0; }

        .empty-state {
            text-align: center; color: var(--text-muted); font-size: 0.9rem; padding: 2rem;
        }
    </style>
</head>
<body>

<div class="app-container">
    <header class="app-header">
        <a href="javascript:history.back()" class="back-arrow">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
        </a>
        <h1 id="pageTitle">Profil</h1>
        <div style="width: 40px;"></div>
    </header>

    <main class="app-content">
        
        <div id="loading" style="text-align: center; padding: 3rem;">Lade Profil...</div>

        <div id="profileContent" style="display:none;">
            <!-- Profile Header -->
            <div class="profile-header-card">
                <div class="profile-avatar-large" id="profileAvatar"></div>
                <h2 class="profile-name">
                    <span id="profileName">Name</span>
                    <span id="verifiedBadge" class="badge badge-verified" style="display:none; font-size: 0.7rem; padding: 2px 6px; margin-left: 0.5rem;">‚úì</span>
                </h2>
                <p class="profile-meta" id="profileMeta">Mitglied seit ...</p>

                <div class="badge-container" id="badges">
                    <!-- Badges werden hier eingef√ºgt -->
                </div>

                <div class="profile-actions">
                    <button class="btn-message" id="messageBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        Nachricht
                    </button>
                    <button class="btn-report" id="reportBtn" title="Nutzer melden">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg>
                    </button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="profile-tabs">
                <button class="tab-btn active" onclick="switchTab('info')">Info</button>
                <button class="tab-btn" onclick="switchTab('listings')" id="tabListingsLabel">Inserate</button>
                <button class="tab-btn" onclick="switchTab('reviews')" id="tabReviewsLabel">Bewertungen</button>
            </div>

            <!-- Tab: Info -->
            <div id="tab-info" class="tab-content active">
                <div class="info-section" id="bioSection" style="display:none;">
                    <h3>√úber mich</h3>
                    <p id="bioText" style="color: #4B5563; line-height: 1.5;"></p>
                </div>

                <div class="info-section">
                    <h3>Details</h3>
                    <div class="info-grid" id="detailsGrid">
                        <!-- Wird dynamisch gef√ºllt -->
                    </div>
                </div>

                <div class="info-section" id="interestsSection" style="display:none;">
                    <h3>Interessen</h3>
                    <div class="tags-container" id="interestsTags"></div>
                </div>
            </div>

            <!-- Tab: Listings -->
            <div id="tab-listings" class="tab-content">
                <div class="mini-listings-grid" id="listingsContainer">
                    <div class="empty-state">Keine aktiven Inserate</div>
                </div>
            </div>

            <!-- Tab: Reviews -->
            <div id="tab-reviews" class="tab-content">
                <div id="reviewsContainer">
                    <div class="empty-state">Noch keine Bewertungen</div>
                </div>
            </div>
        </div>

    </main>

    <div id="app-footer-nav"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>
<script src="navigation.js"></script>
<script>
    // Config Fallback
    if (typeof SUPABASE_URL === 'undefined' || typeof SUPABASE_ANON_KEY === 'undefined') {
        var SUPABASE_URL = 'https://tvnvmogaqmduzcycmvby.supabase.co';
        var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2bnZtb2dhcW1kdXpjeWNtdmJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NTA4MTksImV4cCI6MjA3MDUyNjgxOX0.MuLv9AdclVVZYZpUFv6Bc2Jn1Z9cmmcarHwBHlHkvZw';
    }

    var supabase;
    if (typeof window.supabase !== 'undefined' && window.supabase.createClient) {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    // URL Params
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('id');
    
    var currentUser = null;

    // Helper: Navigation
    function navigateTo(url) {
        try { window.location.href = url; } catch(e) { console.warn(e); }
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        // Finde den Button, der geklickt wurde (etwas hacky aber funktional)
        const buttons = document.querySelectorAll('.tab-btn');
        if (tabName === 'info') buttons[0].classList.add('active');
        if (tabName === 'listings') buttons[1].classList.add('active');
        if (tabName === 'reviews') buttons[2].classList.add('active');

        document.getElementById('tab-' + tabName).classList.add('active');
    }

    async function initProfile() {
        if (!userId || !supabase) {
            document.getElementById('loading').innerHTML = "Nutzer nicht gefunden.";
            return;
        }

        // Auth Check
        const { data: { user } } = await supabase.auth.getUser();
        currentUser = user;

        // Eigene Profilseite?
        if (currentUser && currentUser.id === userId) {
            document.getElementById('messageBtn').style.display = 'none';
            document.getElementById('reportBtn').style.display = 'none';
        }

        loadUserProfile();
        loadUserListings();
        loadUserReviews();
    }

    async function loadUserProfile() {
        const { data: profile, error } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', userId)
            .single();

        if (error || !profile) {
            document.getElementById('loading').innerHTML = "Profil konnte nicht geladen werden.";
            return;
        }

        // Show Content
        document.getElementById('loading').style.display = 'none';
        document.getElementById('profileContent').style.display = 'block';

        // Fill Header
        const name = profile.full_name || profile.username || 'Nutzer';
        document.getElementById('pageTitle').textContent = name;
        document.getElementById('profileName').textContent = name;
        
        const joined = new Date(profile.created_at).toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
        document.getElementById('profileMeta').textContent = `Mitglied seit ${joined}`;

        const avatarEl = document.getElementById('profileAvatar');
        if (profile.avatar_url) {
            avatarEl.style.backgroundImage = `url('${profile.avatar_url}')`;
            avatarEl.textContent = '';
        } else {
            avatarEl.textContent = name.charAt(0).toUpperCase();
        }

        // Badges
        const badgesContainer = document.getElementById('badges');
        if (profile.is_verified) {
            document.getElementById('verifiedBadge').style.display = 'inline';
            badgesContainer.innerHTML += `<span class="badge badge-verified">‚úì Verifiziert</span>`;
        }
        if (profile.is_student_verified) {
            badgesContainer.innerHTML += `<span class="badge badge-student">üéì Student</span>`;
        }

        // INFO TAB FILL
        if (profile.bio) {
            document.getElementById('bioText').textContent = profile.bio;
            document.getElementById('bioSection').style.display = 'block';
        }

        // Detailed Info Grid
        const grid = document.getElementById('detailsGrid');
        
        function addInfo(label, val) {
            if(val) grid.innerHTML += `<div class="info-item"><span class="info-label">${label}</span><span class="info-value">${val}</span></div>`;
        }

        addInfo('Stadt', profile.city);
        addInfo('Universit√§t', profile.university);
        addInfo('Studiengang', profile.study_field);
        addInfo('Semester', profile.semester);
        addInfo('Alter', profile.age);
        addInfo('Sprachen', profile.languages);

        // Interests
        if (profile.interests) {
            const tagsContainer = document.getElementById('interestsTags');
            const interests = profile.interests.split(',').map(i => i.trim());
            interests.forEach(i => {
                if(i) tagsContainer.innerHTML += `<span class="tag">${i}</span>`;
            });
            document.getElementById('interestsSection').style.display = 'block';
        }

        // Buttons
        document.getElementById('messageBtn').onclick = () => {
            if (!currentUser) {
                if(confirm("Bitte einloggen um Nachrichten zu senden.")) navigateTo('login.html');
                return;
            }
            navigateTo(`chat.html?user=${userId}`);
        };

        document.getElementById('reportBtn').onclick = () => {
            if (!currentUser) return alert("Bitte einloggen.");
            const reason = prompt("Nutzer melden wegen:");
            if (reason) {
                supabase.from('reports').insert({
                    reporter_id: currentUser.id,
                    reported_type: 'user',
                    reported_id: userId,
                    reason: reason
                }).then(() => alert("Gemeldet. Danke!"));
            }
        };
    }

    async function loadUserListings() {
        const { data: listings } = await supabase
            .from('listings')
            .select('id, title, price, monthly_rent, type, listing_photos(storage_path)')
            .eq('owner_id', userId)
            .eq('is_active', true)
            .order('created_at', { ascending: false });

        document.getElementById('tabListingsLabel').textContent = `Inserate (${listings ? listings.length : 0})`;
        const container = document.getElementById('listingsContainer');

        if (!listings || listings.length === 0) {
            container.innerHTML = '<div class="empty-state">Keine aktiven Inserate</div>';
            return;
        }

        container.innerHTML = '';
        listings.forEach(l => {
            let imgUrl = 'https://via.placeholder.com/150?text=Room8';
            if (l.listing_photos && l.listing_photos.length > 0) {
                const { data } = supabase.storage.from('listing-images').getPublicUrl(l.listing_photos[0].storage_path);
                if (data) imgUrl = data.publicUrl;
            }

            const price = l.type === 'wohnung' ? (l.monthly_rent ? l.monthly_rent + ' ‚Ç¨' : 'VB') : (l.price ? l.price + ' ‚Ç¨' : 'VB');

            // Verwende onclick statt href f√ºr Sicherheit in Vorschau
            const item = document.createElement('div');
            item.className = 'mini-card';
            item.onclick = () => navigateTo(`listing-details.html?id=${l.id}`);
            item.style.cursor = 'pointer';
            item.innerHTML = `
                <img src="${imgUrl}" class="mini-card-img">
                <div class="mini-card-body">
                    <h4 class="mini-card-title">${l.title}</h4>
                    <div class="mini-card-price">${price}</div>
                </div>
            `;
            container.appendChild(item);
        });
    }

    async function loadUserReviews() {
        const { data: reviews } = await supabase
            .from('reviews')
            .select('rating, comment, created_at, reviewer:reviewer_id(username)')
            .eq('reviewee_id', userId)
            .order('created_at', { ascending: false });

        document.getElementById('tabReviewsLabel').textContent = `Bewertungen (${reviews ? reviews.length : 0})`;
        const container = document.getElementById('reviewsContainer');

        if (!reviews || reviews.length === 0) {
            container.innerHTML = '<div class="empty-state">Noch keine Bewertungen</div>';
            return;
        }

        container.innerHTML = '';
        reviews.forEach(r => {
            const stars = '‚≠ê'.repeat(r.rating);
            const date = new Date(r.created_at).toLocaleDateString();
            const reviewerName = r.reviewer ? r.reviewer.username : 'Anonym';

            container.innerHTML += `
                <div class="review-item">
                    <div class="review-header">
                        <span class="review-author">${reviewerName}</span>
                        <span class="review-date">${date}</span>
                    </div>
                    <div class="review-stars">${stars}</div>
                    <p class="review-text">${r.comment || ''}</p>
                </div>
            `;
        });
    }

    // Init
    if(supabase) initProfile();
</script>
</body>
</html>