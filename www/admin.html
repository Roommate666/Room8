<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Panel - Room8</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Admin-Spezifische Styles */
        body { background: #f3f4f6; }
        
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
            padding-bottom: 5rem;
        }
        
        .admin-header {
            background: #111827;
            color: white;
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .admin-header h1 { margin: 0 0 0.5rem 0; font-size: 1.5rem; }
        .admin-header p { margin: 0; opacity: 0.7; font-size: 0.9rem; }
        .back-link { color: white; opacity: 0.8; text-decoration: none; font-weight: 500; }
        .back-link:hover { opacity: 1; }

        /* Schnellzugriff Buttons */
        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .quick-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-decoration: none;
            color: var(--text-main);
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .quick-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .qc-icon { font-size: 1.5rem; }
        .qc-text { font-weight: 600; }

        /* Tabs */
        .admin-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0;
            overflow-x: auto;
            padding-bottom: 1rem;
        }
        
        .admin-tab {
            padding: 0.75rem 1.5rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 99px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            color: #6b7280;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .admin-tab:hover { border-color: #d1d5db; color: #374151; }
        .admin-tab.active { background: #111827; color: white; border-color: #111827; }
        
        .tab-badge {
            background: #ef4444;
            color: white;
            padding: 0.1rem 0.5rem;
            border-radius: 99px;
            font-size: 0.75rem;
        }

        /* Content Sections */
        .admin-section { display: none; animation: fadeIn 0.3s ease; }
        .admin-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Listen & Karten */
        .data-list { display: flex; flex-direction: column; gap: 1rem; }
        
        .admin-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #f3f4f6;
        }

        .card-title { font-weight: 700; font-size: 1.1rem; color: #111827; display: flex; align-items: center; gap: 0.5rem; }
        .card-meta { font-size: 0.85rem; color: #6b7280; margin-top: 0.25rem; }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            background: #F9FAFB;
            padding: 1rem;
            border-radius: 8px;
        }
        .info-item label { font-size: 0.75rem; color: #9CA3AF; text-transform: uppercase; font-weight: 600; display: block; }
        .info-item span { font-size: 0.9rem; font-weight: 500; color: #374151; word-break: break-all; }
        
        .action-bar {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        /* Buttons */
        .btn-mini {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            text-decoration: none;
            transition: filter 0.2s;
        }
        .btn-mini:hover { filter: brightness(0.95); }

        .btn-green { background: #D1FAE5; color: #065F46; }
        .btn-red { background: #FEE2E2; color: #991B1B; }
        .btn-blue { background: #DBEAFE; color: #1E40AF; }
        .btn-yellow { background: #FEF3C7; color: #92400E; }
        .btn-gray { background: #F3F4F6; color: #374151; }

        /* Stats */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-box {
            background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #e5e7eb;
        }
        .stat-val { font-size: 2rem; font-weight: 800; color: #111827; }
        .stat-lbl { font-size: 0.85rem; color: #6b7280; font-weight: 500; }

        /* Loading / Empty */
        .loading-state, .empty-state {
            text-align: center; padding: 3rem; color: #6b7280;
        }
    </style>
</head>
<body>

<div class="admin-container">
    
    <!-- Header -->
    <header class="admin-header">
        <div>
            <h1>üõ°Ô∏è Admin Control</h1>
            <p>Angemeldet als: <span id="adminEmail">...</span></p>
        </div>
        <a href="dashboard.html" class="back-link">‚Üê Zur App</a>
    </header>

    <!-- Stats -->
    <div class="stats-row">
        <div class="stat-box">
            <div class="stat-val" id="statReports">-</div>
            <div class="stat-lbl">üî¥ Offene Meldungen</div>
        </div>
        <div class="stat-box">
            <div class="stat-val" id="statPending">-</div>
            <div class="stat-lbl">‚è≥ Verifizierungen</div>
        </div>
        <div class="stat-box">
            <div class="stat-val" id="statUsers">-</div>
            <div class="stat-lbl">üë• Nutzer Total</div>
        </div>
        <div class="stat-box">
            <div class="stat-val" id="statListings">-</div>
            <div class="stat-lbl">üè† Aktive Inserate</div>
        </div>
    </div>

    <!-- Quick Create -->
    <div class="quick-actions-grid">
        <a href="job-create.html" class="quick-card">
            <span class="qc-icon">üíº</span>
            <span class="qc-text">Job erstellen</span>
        </a>
        <a href="coupon-create.html" class="quick-card">
            <span class="qc-icon">üéüÔ∏è</span>
            <span class="qc-text">Coupon erstellen</span>
        </a>
    </div>

    <!-- Navigation Tabs -->
    <div class="admin-tabs">
        <button class="admin-tab active" onclick="switchTab('reports')">
            ‚ö†Ô∏è Meldungen <span class="tab-badge" id="badgeReports" style="display:none">0</span>
        </button>
        <button class="admin-tab" onclick="switchTab('verifications')">
            üéì Verifizierungen <span class="tab-badge" id="badgeVerifications" style="display:none">0</span>
        </button>
        <button class="admin-tab" onclick="switchTab('users')">
            üë• Nutzer
        </button>
        <button class="admin-tab" onclick="switchTab('listings')">
            üè† Inserate
        </button>
    </div>

    <!-- 1. REPORTS SECTION -->
    <div id="tab-reports" class="admin-section active">
        <div id="reportsList" class="data-list">
            <div class="loading-state">Lade Meldungen...</div>
        </div>
    </div>

    <!-- 2. VERIFICATIONS SECTION -->
    <div id="tab-verifications" class="admin-section">
        <div id="verificationsList" class="data-list">
            <div class="loading-state">Lade Verifizierungen...</div>
        </div>
    </div>

    <!-- 3. USERS SECTION -->
    <div id="tab-users" class="admin-section">
        <div style="margin-bottom:1rem;">
            <input type="text" id="userSearch" placeholder="Suche nach E-Mail oder Name..." style="padding:0.75rem; width:100%; border-radius:8px; border:1px solid #e5e7eb;">
        </div>
        <div id="usersList" class="data-list">
            <div class="loading-state">Lade Nutzer...</div>
        </div>
    </div>

    <!-- 4. LISTINGS SECTION -->
    <div id="tab-listings" class="admin-section">
        <div id="listingsList" class="data-list">
            <div class="loading-state">Lade Inserate...</div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>
<script>
    // 1. Config Fallback
    if (typeof SUPABASE_URL === 'undefined') { var SUPABASE_URL = 'https://tvnvmogaqmduzcycmvby.supabase.co'; var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2bnZtb2dhcW1kdXpjeWNtdmJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NTA4MTksImV4cCI6MjA3MDUyNjgxOX0.MuLv9AdclVVZYZpUFv6Bc2Jn1Z9cmmcarHwBHlHkvZw'; }
    var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const ADMIN_EMAIL = 'albayrak_yusuf@icloud.com';

    // Helper: Navigation
    function navigateTo(url) {
        try { window.location.href = url; } catch(e) { console.warn(e); }
    }

    // 2. Auth Check
    async function checkAdmin() {
        const { data: { user } } = await supabase.auth.getUser();
        
        if (!user || user.email !== ADMIN_EMAIL) {
            alert("Zugriff verweigert!");
            navigateTo('dashboard.html');
            return;
        }
        document.getElementById('adminEmail').textContent = user.email;
        loadAllData();
    }

    // 3. Data Loading
    async function loadAllData() {
        loadStats();
        loadReports();
        loadVerifications();
        loadUsers(); // L√§dt erstmal die neuesten 20
        loadListings(); // L√§dt erstmal die neuesten 20
    }

    async function loadStats() {
        // Simple counts via Separate Queries
        const pending = await supabase.from('profiles').select('id', { count: 'exact', head: true }).eq('verification_status', 'pending');
        const reports = await supabase.from('reports').select('id', { count: 'exact', head: true }).eq('status', 'open');
        const users = await supabase.from('profiles').select('id', { count: 'exact', head: true });
        const listings = await supabase.from('listings').select('id', { count: 'exact', head: true }).eq('is_active', true);

        document.getElementById('statPending').textContent = pending.count || 0;
        document.getElementById('statReports').textContent = reports.count || 0;
        document.getElementById('statUsers').textContent = users.count || 0;
        document.getElementById('statListings').textContent = listings.count || 0;

        // Badges
        if (pending.count > 0) {
            const b = document.getElementById('badgeVerifications');
            b.textContent = pending.count;
            b.style.display = 'inline-block';
        }
        if (reports.count > 0) {
            const b = document.getElementById('badgeReports');
            b.textContent = reports.count;
            b.style.display = 'inline-block';
        }
    }

    // --- REPORTS ---
    async function loadReports() {
        const container = document.getElementById('reportsList');
        // Fetch Reports inkl. Reporter Details
        // Hinweis: Wir versuchen auch reported_user und listing zu joinen, falls Foreign Keys passen.
        // Wenn nicht, laden wir IDs und zeigen Links.
        const { data: reports, error } = await supabase
            .from('reports')
            .select(`
                *,
                reporter:reporter_id(email, full_name, username)
            `)
            .eq('status', 'open')
            .order('created_at', { ascending: false });

        if (error) {
            container.innerHTML = `<p style="color:red">Fehler: ${error.message}</p>`;
            return;
        }

        if (reports.length === 0) {
            container.innerHTML = '<div class="empty-state">Keine offenen Meldungen ‚úÖ</div>';
            return;
        }

        container.innerHTML = reports.map(r => {
            const reporterName = r.reporter ? (r.reporter.full_name || r.reporter.email) : 'Unbekannt';
            const date = new Date(r.created_at).toLocaleDateString('de-DE');
            
            // Dynamische Links basierend auf Typ
            let linksHtml = '';
            if (r.reported_type === 'listing' || r.reported_type === 'wohnung' || r.reported_type === 'gegenstand') {
                linksHtml += `<a href="listing-details.html?id=${r.reported_id}" target="_blank" class="btn-mini btn-blue">üè† Inserat ansehen</a>`;
            } else if (r.reported_type === 'user') {
                linksHtml += `<a href="public-profile.html?id=${r.reported_id}" target="_blank" class="btn-mini btn-blue">üë§ Profil ansehen</a>`;
            }

            return `
                <div class="admin-card">
                    <div class="card-header">
                        <div class="card-title">üö® Meldung: ${r.reason}</div>
                        <span class="status-badge status-pending">Offen</span>
                    </div>
                    <div class="info-grid">
                        <div class="info-item"><label>Melder</label><span>${reporterName}</span></div>
                        <div class="info-item"><label>Datum</label><span>${date}</span></div>
                        <div class="info-item"><label>Typ</label><span>${r.reported_type}</span></div>
                        <div class="info-item"><label>Betroffene ID</label><span>${r.reported_id}</span></div>
                    </div>
                    <p style="background:#FFFBEB; padding:0.5rem; border-radius:4px; color:#92400E;">
                        <strong>Beschreibung:</strong> ${r.description || 'Keine Details'}
                    </p>
                    <div class="action-bar">
                        ${linksHtml}
                        <button class="btn-mini btn-green" onclick="resolveReport('${r.id}')">‚úÖ Erledigt</button>
                        <button class="btn-mini btn-red" onclick="banTarget('${r.reported_id}', '${r.reported_type}')">üö´ User/Owner Sperren</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    // --- VERIFICATIONS ---
    async function loadVerifications() {
        const container = document.getElementById('verificationsList');
        const { data: profiles, error } = await supabase
            .from('profiles')
            .select('*')
            .eq('verification_status', 'pending');

        if (profiles.length === 0) {
            container.innerHTML = '<div class="empty-state">Keine offenen Verifizierungen.</div>';
            return;
        }

        container.innerHTML = profiles.map(p => {
            const proof = p.verification_method === 'uni-email' 
                ? `Uni-Mail: <strong>${p.uni_email}</strong>` 
                : `<button class="btn-mini btn-blue" onclick="viewDoc('${p.verification_document_url}')">üìÑ Dokument √∂ffnen</button>`;

            return `
                <div class="admin-card">
                    <div class="card-header">
                        <div class="card-title">üéì ${p.full_name || p.username || p.email}</div>
                    </div>
                    <div class="info-grid">
                        <div class="info-item"><label>Email</label><span>${p.email}</span></div>
                        <div class="info-item"><label>Beweis</label><span>${proof}</span></div>
                    </div>
                    <div class="action-bar">
                        <button class="btn-mini btn-green" onclick="verifyUser('${p.id}', true)">Genehmigen</button>
                        <button class="btn-mini btn-red" onclick="verifyUser('${p.id}', false)">Ablehnen</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    // --- USERS ---
    async function loadUsers() {
        const container = document.getElementById('usersList');
        const search = document.getElementById('userSearch').value.toLowerCase();
        
        let query = supabase.from('profiles').select('*').order('created_at', { ascending: false }).limit(20);
        
        const { data: users } = await query;
        
        // Client-Side Filter (einfacher f√ºr Demo)
        const filtered = users.filter(u => 
            (u.email && u.email.toLowerCase().includes(search)) || 
            (u.full_name && u.full_name.toLowerCase().includes(search))
        );

        container.innerHTML = filtered.map(u => {
            const status = u.is_banned ? 'üö´ Gesperrt' : (u.is_verified ? '‚úÖ Verifiziert' : 'Standard');
            return `
                <div class="admin-card">
                    <div class="card-header">
                        <div class="card-title">üë§ ${u.email}</div>
                        <span>${status}</span>
                    </div>
                    <div class="info-grid">
                        <div class="info-item"><label>Name</label><span>${u.full_name || '-'}</span></div>
                        <div class="info-item"><label>ID</label><span>${u.id}</span></div>
                    </div>
                    <div class="action-bar">
                        <a href="public-profile.html?id=${u.id}" target="_blank" class="btn-mini btn-blue">Profil</a>
                        ${u.is_banned 
                            ? `<button class="btn-mini btn-green" onclick="unbanUser('${u.id}')">Entsperren</button>` 
                            : `<button class="btn-mini btn-red" onclick="banUser('${u.id}')">Sperren</button>`
                        }
                    </div>
                </div>
            `;
        }).join('');
    }

    document.getElementById('userSearch').addEventListener('input', loadUsers);

    // --- LISTINGS ---
    async function loadListings() {
        const container = document.getElementById('listingsList');
        const { data: listings } = await supabase.from('listings').select('*').order('created_at', { ascending: false }).limit(20);

        container.innerHTML = listings.map(l => `
            <div class="admin-card">
                <div class="card-header">
                    <div class="card-title">${l.title}</div>
                    <span>${l.is_active ? '‚úÖ Aktiv' : '‚è∏Ô∏è Inaktiv'}</span>
                </div>
                <div class="info-grid">
                    <div class="info-item"><label>Preis</label><span>${l.price || l.monthly_rent || '-'}</span></div>
                    <div class="info-item"><label>Typ</label><span>${l.type}</span></div>
                </div>
                <div class="action-bar">
                    <a href="listing-details.html?id=${l.id}" target="_blank" class="btn-mini btn-blue">Ansehen</a>
                    <button class="btn-mini btn-red" onclick="deleteListing('${l.id}')">L√∂schen</button>
                </div>
            </div>
        `).join('');
    }

    // --- ACTIONS ---

    window.resolveReport = async (id) => {
        if(!confirm("Meldung schlie√üen?")) return;
        await supabase.from('reports').update({ status: 'resolved' }).eq('id', id);
        loadReports();
    };

    window.banUser = async (id) => {
        if(!confirm("Nutzer wirklich sperren?")) return;
        await supabase.from('profiles').update({ is_banned: true }).eq('id', id);
        alert("Gesperrt.");
        loadUsers();
    };

    window.unbanUser = async (id) => {
        await supabase.from('profiles').update({ is_banned: false }).eq('id', id);
        alert("Entsperrt.");
        loadUsers();
    };

    window.banTarget = async (id, type) => {
        if (type === 'user') return window.banUser(id);
        // Wenn Inserat gemeldet wurde, sperren wir den Besitzer
        if (type === 'listing' || type === 'wohnung' || type === 'gegenstand') {
            const { data } = await supabase.from('listings').select('owner_id').eq('id', id).single();
            if(data) window.banUser(data.owner_id);
        }
    };

    window.verifyUser = async (id, approve) => {
        const updates = {
            verification_status: approve ? 'approved' : 'rejected',
            is_verified: approve,
            is_student_verified: approve
        };
        await supabase.from('profiles').update(updates).eq('id', id);
        loadVerifications();
    };

    window.viewDoc = async (path) => {
        const { data } = await supabase.storage.from('verification-documents').createSignedUrl(path, 60);
        if (data) window.open(data.signedUrl, '_blank');
        else alert("Fehler beim √ñffnen.");
    };

    window.deleteListing = async (id) => {
        if(!confirm("Endg√ºltig l√∂schen?")) return;
        await supabase.from('listings').delete().eq('id', id);
        loadListings();
    };

    window.switchTab = (tab) => {
        document.querySelectorAll('.admin-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.admin-tab').forEach(el => el.classList.remove('active'));
        
        document.getElementById(`tab-${tab}`).classList.add('active');
        // Button highlighten (einfach √ºber text match, oder sauberer mit ids)
        event.target.classList.add('active');
    }

    checkAdmin();
</script>
</body>
</html>