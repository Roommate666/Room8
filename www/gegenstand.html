<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inserat erstellen - Room8</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* === Spezifische Styles f√ºr Upload & Formular === */
        
        /* Upload Bereich */
        .upload-area {
            background-color: #F9FAFB;
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 1rem;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background-color: #EEF2FF;
        }

        .upload-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        /* Bilder Vorschau Gitter */
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius-sm);
            overflow: hidden;
            border: 1px solid var(--border-color);
            background: #fff;
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(0,0,0,0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .remove-btn:hover {
            background: #EF4444;
        }

        /* Modus-Schalter (Verkaufen / Suche) */
        .mode-switch {
            display: flex;
            background: #F3F4F6;
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .mode-option {
            flex: 1;
            text-align: center;
            padding: 0.6rem;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .mode-option.active {
            background: white;
            color: var(--text-main);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-weight: 600;
        }
        
        .section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 0.5rem;
            display: block;
        }
    </style>
</head>
<body>

<div class="app-container">
    <header class="app-header">
        <a href="choose-listing.html" class="back-arrow">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
        </a>
        <h1 id="pageTitle">Verkaufen</h1>
        <div style="width: 40px;"></div>
    </header>

    <main class="app-content">
        
        <!-- Modus Auswahl -->
        <div class="mode-switch">
            <div class="mode-option active" id="mode-offer" onclick="setMode('offer')">Verkaufen</div>
            <div class="mode-option" id="mode-search" onclick="setMode('search')">Suche</div>
        </div>

        <form id="createForm">
            <!-- Bilder Upload -->
            <div class="form-group" id="imageSection">
                <label class="section-title">Fotos (Max. 5)</label>
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <span class="upload-icon">üì∑</span>
                    <div style="font-size: 0.9rem; color: var(--text-muted);">Tippen zum Ausw√§hlen</div>
                </div>
                <input type="file" id="fileInput" multiple accept="image/*" style="display: none;" onchange="handleFiles(this.files)">
                <div class="preview-grid" id="previewGrid"></div>
                <div id="photoCounter" style="text-align: center; font-size: 0.8rem; color: var(--text-light); margin-top: -1rem; margin-bottom: 1rem;">0 / 5 Fotos</div>
            </div>

            <!-- Titel -->
            <div class="form-group">
                <label for="title">Titel</label>
                <input type="text" id="title" required placeholder="Was m√∂chtest du anbieten?">
            </div>

            <!-- Preis -->
            <div class="form-group" id="price-group">
                <label for="price">Preis (‚Ç¨)</label>
                <input type="number" id="price" required placeholder="0.00" step="0.01">
            </div>
            
            <!-- Preisbereich (nur f√ºr Suche) -->
            <div class="form-group hidden" id="price-range-group">
                <label>Preisvorstellung (‚Ç¨)</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="price_min" placeholder="Min" step="0.01">
                    <input type="number" id="price_max" placeholder="Max" step="0.01">
                </div>
            </div>

            <!-- Kategorie -->
            <div class="form-group">
                <label for="category">Kategorie</label>
                <select id="category" required>
                    <option value="" disabled selected>Bitte w√§hlen</option>
                    <option value="Furniture & Home">M√∂bel & Wohnen</option>
                    <option value="Electronics & Tech">Elektronik</option>
                    <option value="Books & Study">B√ºcher & Studium</option>
                    <option value="Clothing & Fashion">Kleidung</option>
                    <option value="Sports & Outdoor">Sport & Freizeit</option>
                    <option value="Kitchen & Appliances">K√ºche</option>
                    <option value="Bikes & Transport">Fahrrad & Transport</option>
                    <option value="Music & Instruments">Musik</option>
                    <option value="Others">Sonstiges</option>
                </select>
            </div>

            <!-- Zustand -->
            <div class="form-group">
                <label for="condition">Zustand</label>
                <select id="condition" required>
                    <option value="" disabled selected>Bitte w√§hlen</option>
                    <option value="New">Neu</option>
                    <option value="Like New">Wie neu</option>
                    <option value="Good">Gut</option>
                    <option value="Fair">Ok</option>
                    <option value="Poor">Gebraucht</option>
                </select>
            </div>

            <!-- Stadt -->
            <div class="form-group">
                <label for="city">Stadt</label>
                <input type="text" id="city" required placeholder="Wo befindet sich der Artikel?" list="citySuggestions">
                <datalist id="citySuggestions"></datalist>
            </div>

            <!-- Beschreibung -->
            <div class="form-group">
                <label for="description">Beschreibung</label>
                <textarea id="description" rows="5" required placeholder="Beschreibe den Artikel genauer..."></textarea>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">Ver√∂ffentlichen</button>
        </form>

    </main>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>
<script src="cities.js"></script> 

<script>
    // 1. Config Fallback (Rettungsschirm)
    if (typeof SUPABASE_URL === 'undefined' || typeof SUPABASE_ANON_KEY === 'undefined') {
        console.warn("Config missing, using fallback.");
        var SUPABASE_URL = 'https://tvnvmogaqmduzcycmvby.supabase.co';
        var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2bnZtb2dhcW1kdXpjeWNtdmJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NTA4MTksImV4cCI6MjA3MDUyNjgxOX0.MuLv9AdclVVZYZpUFv6Bc2Jn1Z9cmmcarHwBHlHkvZw';
    }

    // 2. Init Supabase
    var supabase;
    if (typeof window.supabase !== 'undefined' && window.supabase.createClient) {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } else if (typeof window.supabaseClient !== 'undefined') {
        supabase = window.supabaseClient;
    }

    // 3. Stadt-Vorschl√§ge laden
    if (typeof populateCityDatalist === 'function') {
        populateCityDatalist('citySuggestions');
    }

    // Variablen
    var selectedFiles = [];
    var currentMode = 'offer';
    
    // URL Parameter checken (z.B. ?mode=search)
    var urlParams = new URLSearchParams(window.location.search);
    var modeParam = urlParams.get('mode');
    if (modeParam) setMode(modeParam);

    function setMode(mode) {
        currentMode = mode;
        // UI Umschalten
        document.getElementById('mode-offer').className = mode === 'offer' ? 'mode-option active' : 'mode-option';
        document.getElementById('mode-search').className = mode === 'search' ? 'mode-option active' : 'mode-option';
        
        var pageTitle = document.getElementById('pageTitle');
        var submitBtn = document.getElementById('submitBtn');
        var priceGroup = document.getElementById('price-group');
        var priceRangeGroup = document.getElementById('price-range-group');
        var priceInput = document.getElementById('price');

        if (mode === 'search') {
            pageTitle.textContent = 'Gesuch aufgeben';
            submitBtn.textContent = 'Gesuch ver√∂ffentlichen';
            priceGroup.classList.add('hidden');
            priceRangeGroup.classList.remove('hidden');
            priceInput.required = false;
        } else {
            pageTitle.textContent = 'Verkaufen';
            submitBtn.textContent = 'Ver√∂ffentlichen';
            priceGroup.classList.remove('hidden');
            priceRangeGroup.classList.add('hidden');
            priceInput.required = true;
        }
    }

    // Datei Handling
    function handleFiles(files) {
        var grid = document.getElementById('previewGrid');
        
        for (var i = 0; i < files.length; i++) {
            if (selectedFiles.length >= 5) break; // Max 5
            
            var file = files[i];
            selectedFiles.push(file);

            // Vorschau Element bauen
            var div = document.createElement('div');
            div.className = 'preview-item';
            
            var img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            
            var btn = document.createElement('button');
            btn.className = 'remove-btn';
            btn.innerHTML = '√ó';
            // Wir nutzen Closure, um den Index zu merken
            btn.onclick = (function(index, element) {
                return function(e) { 
                    e.preventDefault(); 
                    removeFile(index, element); 
                };
            })(selectedFiles.length - 1, div);

            div.appendChild(img);
            div.appendChild(btn);
            grid.appendChild(div);
        }
        updateCounter();
    }

    function removeFile(index, element) {
        element.remove();
        selectedFiles[index] = null; // Als gel√∂scht markieren
        updateCounter();
    }

    function updateCounter() {
        var activeCount = selectedFiles.filter(f => f !== null).length;
        document.getElementById('photoCounter').textContent = activeCount + ' / 5 Fotos';
        
        // Upload Button ausblenden wenn voll
        var uploadArea = document.querySelector('.upload-area');
        if (activeCount >= 5) {
            uploadArea.style.display = 'none';
        } else {
            uploadArea.style.display = 'block';
        }
    }

    // Formular Absenden
    document.getElementById('createForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        var btn = document.getElementById('submitBtn');
        btn.disabled = true;
        var originalText = btn.textContent;
        btn.textContent = "Wird gespeichert...";

        try {
            // 1. Auth Check
            var { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                alert("Bitte erst einloggen.");
                window.location.href = 'login.html';
                return;
            }

            // 2. Daten sammeln
            var title = document.getElementById('title').value;
            var category = document.getElementById('category').value;
            var condition = document.getElementById('condition').value;
            var city = document.getElementById('city').value;
            var description = document.getElementById('description').value;
            
            var price = null;
            var priceMin = null;
            var priceMax = null;

            if (currentMode === 'offer') {
                price = document.getElementById('price').value;
            } else {
                priceMin = document.getElementById('price_min').value || null;
                priceMax = document.getElementById('price_max').value || null;
            }

            // 3. Listing in DB erstellen
            var insertData = {
                owner_id: user.id,
                type: 'gegenstand',
                title: title,
                price: price,
                price_range_min: priceMin,
                price_range_max: priceMax,
                category: category,
                condition: condition, 
                city: city,
                description: description,
                listing_mode: currentMode,
                is_active: true
            };

            var { data: listing, error: insertError } = await supabase
                .from('listings')
                .insert(insertData)
                .select()
                .single();

            if (insertError) throw insertError;

            // 4. Bilder hochladen
            var activeFiles = selectedFiles.filter(f => f !== null);
            
            if (activeFiles.length > 0) {
                btn.textContent = "Lade Bilder hoch...";
                
                for (var i = 0; i < activeFiles.length; i++) {
                    var file = activeFiles[i];
                    var fileExt = file.name.split('.').pop();
                    // Eindeutiger Dateiname: listingID_index.ext
                    var fileName = `${listing.id}_${i}.${fileExt}`;
                    
                    // Upload zu Storage
                    var { error: uploadError } = await supabase.storage
                        .from('listing-images')
                        .upload(fileName, file);

                    if (uploadError) {
                        console.error("Bild Upload Fehler:", uploadError);
                        // Wir machen trotzdem weiter, damit das Listing nicht verloren geht
                    } else {
                        // Verkn√ºpfung in DB speichern
                        await supabase.from('listing_photos').insert({
                            listing_id: listing.id,
                            storage_path: fileName,
                            display_order: i
                        });
                    }
                }
            }

            // Erfolg!
            alert("Erfolgreich erstellt!");
            window.location.href = "gegenstaende.html"; // Zur √úbersicht

        } catch (err) {
            console.error(err);
            alert("Fehler: " + err.message);
            btn.disabled = false;
            btn.textContent = originalText;
        }
    });
</script>
</body>
</html>