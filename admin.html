<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">    <title>Admin Panel - Room8</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Admin-Spezifische Styles */
        body { background: #f3f4f6; }
        
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
            padding-bottom: 5rem;
        }
        
        .admin-header {
            background: #111827;
            color: white;
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .admin-header h1 { margin: 0 0 0.5rem 0; font-size: 1.5rem; }
        .admin-header p { margin: 0; opacity: 0.7; font-size: 0.9rem; }
        .back-link { color: white; opacity: 0.8; text-decoration: none; font-weight: 500; }
        .back-link:hover { opacity: 1; }

        /* Schnellzugriff Buttons */
        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .quick-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-decoration: none;
            color: var(--text-main);
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .quick-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .qc-icon { font-size: 1.5rem; }
        .qc-text { font-weight: 600; }

        /* Tabs */
        .admin-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0;
            overflow-x: auto;
            padding-bottom: 1rem;
        }
        
        .admin-tab {
            padding: 0.75rem 1.5rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 99px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            color: #6b7280;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .admin-tab:hover { border-color: #d1d5db; color: #374151; }
        .admin-tab.active { background: #111827; color: white; border-color: #111827; }
        
        .tab-badge {
            background: #ef4444;
            color: white;
            padding: 0.1rem 0.5rem;
            border-radius: 99px;
            font-size: 0.75rem;
        }

        /* Content Sections */
        .admin-section { display: none; animation: fadeIn 0.3s ease; }
        .admin-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Listen & Karten */
        .data-list { display: flex; flex-direction: column; gap: 1rem; }
        
        .admin-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #f3f4f6;
        }

        .card-title { font-weight: 700; font-size: 1.1rem; color: #111827; display: flex; align-items: center; gap: 0.5rem; }
        .card-meta { font-size: 0.85rem; color: #6b7280; margin-top: 0.25rem; }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            background: #F9FAFB;
            padding: 1rem;
            border-radius: 8px;
        }
        .info-item label { font-size: 0.75rem; color: #9CA3AF; text-transform: uppercase; font-weight: 600; display: block; }
        .info-item span { font-size: 0.9rem; font-weight: 500; color: #374151; word-break: break-all; }
        
        .action-bar {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        /* Buttons */
        .btn-mini {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            text-decoration: none;
            transition: filter 0.2s;
        }
        .btn-mini:hover { filter: brightness(0.95); }

        .btn-green { background: #D1FAE5; color: #065F46; }
        .btn-red { background: #FEE2E2; color: #991B1B; }
        .btn-blue { background: #DBEAFE; color: #1E40AF; }
        .btn-yellow { background: #FEF3C7; color: #92400E; }
        .btn-gray { background: #F3F4F6; color: #374151; }

        /* Stats */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-box {
            background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #e5e7eb;
        }
        .stat-val { font-size: 2rem; font-weight: 800; color: #111827; }
        .stat-lbl { font-size: 0.85rem; color: #6b7280; font-weight: 500; }

        /* Loading / Empty */
        .loading-state, .empty-state {
            text-align: center; padding: 3rem; color: #6b7280;
        }

        /* Filter Buttons */
        .filter-btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: white;
            color: #6b7280;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-btn:hover { background: #f9fafb; }
        .filter-btn.active { background: #111827; color: white; border-color: #111827; }

        /* Status Badge */
        .status-badge {
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-badge.status-pending { background: #FEF3C7; color: #92400E; }
        .status-badge.status-approved { background: #D1FAE5; color: #065F46; }
        .status-badge.status-rejected { background: #FEE2E2; color: #991B1B; }
    </style>
</head>
<body>

<div class="admin-container">
    
    <!-- Header -->
    <header class="admin-header">
        <div>
            <h1>üõ°Ô∏è Admin Control</h1>
            <p>Angemeldet als: <span id="adminEmail">...</span></p>
        </div>
        <div style="display:flex; gap:1rem; align-items:center;">
            <a href="admin-debug.html" class="back-link" style="font-size:0.85rem;">üîß Debug</a>
            <a href="dashboard.html" class="back-link">‚Üê Zur App</a>
        </div>
    </header>

    <!-- Stats -->
    <div class="stats-row">
        <div class="stat-box">
            <div class="stat-val" id="statReports">-</div>
            <div class="stat-lbl">üî¥ Offene Meldungen</div>
        </div>
        <div class="stat-box">
            <div class="stat-val" id="statPending">-</div>
            <div class="stat-lbl">‚è≥ Verifizierungen</div>
        </div>
        <div class="stat-box">
            <div class="stat-val" id="statUsers">-</div>
            <div class="stat-lbl">üë• Nutzer Total</div>
        </div>
        <div class="stat-box">
            <div class="stat-val" id="statListings">-</div>
            <div class="stat-lbl">üè† Aktive Inserate</div>
        </div>
        <div class="stat-box">
            <div class="stat-val" id="statMessages">-</div>
            <div class="stat-lbl">üì¨ Neue Nachrichten</div>
        </div>
    </div>

    <!-- Quick Create -->
    <div class="quick-actions-grid">
        <a href="job-create.html" class="quick-card">
            <span class="qc-icon">üíº</span>
            <span class="qc-text">Job erstellen</span>
        </a>
        <a href="coupon-create.html" class="quick-card">
            <span class="qc-icon">üéüÔ∏è</span>
            <span class="qc-text">Coupon erstellen</span>
        </a>
        <a href="partner-job.html" class="quick-card" target="_blank">
            <span class="qc-icon">üìÑ</span>
            <span class="qc-text">Partner Job-Form</span>
        </a>
        <a href="partner-coupon.html" class="quick-card" target="_blank">
            <span class="qc-icon">üìÑ</span>
            <span class="qc-text">Partner Coupon-Form</span>
        </a>
    </div>

    <!-- Navigation Tabs -->
    <div class="admin-tabs">
        <button class="admin-tab active" onclick="switchTab('reports')">
            ‚ö†Ô∏è Meldungen <span class="tab-badge" id="badgeReports" style="display:none">0</span>
        </button>
        <button class="admin-tab" onclick="switchTab('verifications')">
            üéì Verifizierungen <span class="tab-badge" id="badgeVerifications" style="display:none">0</span>
        </button>
        <button class="admin-tab" onclick="switchTab('submissions')">
            üì¨ Einreichungen <span class="tab-badge" id="badgeSubmissions" style="display:none">0</span>
        </button>
        <button class="admin-tab" onclick="switchTab('users')">
            üë• Nutzer
        </button>
        <button class="admin-tab" onclick="switchTab('listings')">
            üè† Wohnungen
        </button>
        <button class="admin-tab" onclick="switchTab('marktplatz')">
            üì¶ Marktplatz
        </button>
        <button class="admin-tab" onclick="switchTab('jobs')">
            üíº Jobs
        </button>
        <button class="admin-tab" onclick="switchTab('coupons')">
            üéüÔ∏è Coupons
        </button>
        <button class="admin-tab" onclick="switchTab('messages')">
            üì¨ Kontakt <span class="tab-badge" id="badgeMessages" style="display:none">0</span>
        </button>
    </div>

    <!-- 1. REPORTS SECTION -->
    <div id="tab-reports" class="admin-section active">
        <div id="reportsList" class="data-list">
            <div class="loading-state">Lade Meldungen...</div>
        </div>
    </div>

    <!-- 2. VERIFICATIONS SECTION -->
    <div id="tab-verifications" class="admin-section">
        <div style="margin-bottom:1rem; display:flex; gap:0.5rem; flex-wrap: wrap;">
            <button class="filter-btn active" onclick="filterVerifications('pending', this)">‚è≥ Offen</button>
            <button class="filter-btn" onclick="filterVerifications('approved', this)">‚úÖ Genehmigt</button>
            <button class="filter-btn" onclick="filterVerifications('rejected', this)">‚ùå Abgelehnt</button>
            <button class="filter-btn" onclick="filterVerifications('all', this)">Alle</button>
        </div>
        <div id="verificationsList" class="data-list">
            <div class="loading-state">Lade Verifizierungen...</div>
        </div>
    </div>

    <!-- 2.5 PARTNER SUBMISSIONS SECTION -->
    <div id="tab-submissions" class="admin-section">
        <div style="margin-bottom:1rem; display:flex; gap:0.5rem;">
            <button class="filter-btn active" onclick="filterSubmissions('all', this)">Alle</button>
            <button class="filter-btn" onclick="filterSubmissions('job', this)">üíº Jobs</button>
            <button class="filter-btn" onclick="filterSubmissions('coupon', this)">üéüÔ∏è Coupons</button>
        </div>
        <div id="submissionsList" class="data-list">
            <div class="loading-state">Lade Einreichungen...</div>
        </div>
    </div>

    <!-- 3. USERS SECTION -->
    <div id="tab-users" class="admin-section">
        <div style="margin-bottom:1rem;">
            <input type="text" id="userSearch" placeholder="Suche nach E-Mail oder Name..." style="padding:0.75rem; width:100%; border-radius:8px; border:1px solid #e5e7eb;">
        </div>
        <div id="usersList" class="data-list">
            <div class="loading-state">Lade Nutzer...</div>
        </div>
    </div>

    <!-- 4. LISTINGS SECTION (Wohnungen) -->
    <div id="tab-listings" class="admin-section">
        <!-- Anleitung Reinigungsservice -->
        <div style="background: linear-gradient(135deg, #0EA5E9 0%, #0284C7 100%); color: white; border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                <span style="font-size: 1.5rem;">üßπ</span>
                <strong style="font-size: 1rem;">Reinigungsservice - So geht's</strong>
            </div>
            <ol style="margin: 0; padding-left: 1.25rem; font-size: 0.85rem; line-height: 1.6;">
                <li>Student ruft an/schreibt mit <strong>Referenz-Nr</strong> (z.B. R8-4F2A3B)</li>
                <li>Du gibst die Nr hier in die Suche ein ‚Üí findest Wohnung mit Adresse</li>
                <li>Student zeigt <strong>Studentenausweis</strong> beim Termin = <strong>15% Rabatt</strong></li>
            </ol>
        </div>
        <div style="margin-bottom:1rem;">
            <input type="text" id="listingSearch" placeholder="üîç Suche nach Referenz-Nr (z.B. R8-4F2A3B), Titel oder Stadt..." style="padding:0.75rem; width:100%; border-radius:8px; border:1px solid #e5e7eb;">
        </div>
        <div id="listingsList" class="data-list">
            <div class="loading-state">Lade Wohnungen...</div>
        </div>
    </div>

    <!-- 5. MARKTPLATZ SECTION -->
    <div id="tab-marktplatz" class="admin-section">
        <div style="margin-bottom:1rem;">
            <input type="text" id="marktplatzSearch" placeholder="üîç Suche nach Titel oder Stadt..." style="padding:0.75rem; width:100%; border-radius:8px; border:1px solid #e5e7eb;">
        </div>
        <div id="marktplatzList" class="data-list">
            <div class="loading-state">Lade Marktplatz...</div>
        </div>
    </div>

    <!-- 6. JOBS SECTION -->
    <div id="tab-jobs" class="admin-section">
        <div style="margin-bottom:1rem;">
            <a href="job-create.html" class="btn-mini btn-green" style="padding:0.75rem 1.5rem;">+ Neuer Job</a>
        </div>
        <div id="jobsList" class="data-list">
            <div class="loading-state">Lade Jobs...</div>
        </div>
    </div>

    <!-- 6. COUPONS SECTION -->
    <div id="tab-coupons" class="admin-section">
        <div style="margin-bottom:1rem;">
            <a href="coupon-create.html" class="btn-mini btn-green" style="padding:0.75rem 1.5rem;">+ Neuer Coupon</a>
        </div>
        <div id="couponsList" class="data-list">
            <div class="loading-state">Lade Coupons...</div>
        </div>
    </div>

    <!-- 7. CONTACT MESSAGES SECTION -->
    <div id="tab-messages" class="admin-section">
        <div style="margin-bottom:1rem; display:flex; gap:0.5rem; flex-wrap: wrap;">
            <button class="filter-btn active" onclick="filterMessages('unread', this)">üì¨ Ungelesen</button>
            <button class="filter-btn" onclick="filterMessages('read', this)">‚úÖ Gelesen</button>
            <button class="filter-btn" onclick="filterMessages('all', this)">Alle</button>
        </div>
        <div id="messagesList" class="data-list">
            <div class="loading-state">Lade Nachrichten...</div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.14"></script>
<script src="config.js"></script>
<script src="room8-ui.js"></script>
<script src="room8-utils.js"></script>
<script>
    // Supabase Client - Direkte Initialisierung
    var sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const ADMIN_EMAIL = 'albayrak_yusuf@icloud.com';

    // Helper: XSS Protection
    function escapeHtml(text) {
        if (text === null || text === undefined) return '';
        return String(text).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // Helper: Navigation
    function navigateTo(url) {
        try { window.location.href = url; } catch(e) { console.warn(e); }
    }

    // 2. Auth Check
    async function checkAdmin() {
        const { data: { user } } = await sb.auth.getUser();
        
        if (!user || user.email !== ADMIN_EMAIL) {
            Room8UI.error("Zugriff verweigert!");
            setTimeout(function() { navigateTo('dashboard.html'); }, 1500);
            return;
        }
        document.getElementById('adminEmail').textContent = user.email;
        loadAllData();
    }

    // 3. Data Loading
    async function loadAllData() {
        loadStats();
        loadReports();
        loadVerifications();
        loadSubmissions();
        loadUsers();
        loadListings();
        loadMarktplatz();
        loadAdminJobs();
        loadAdminCoupons();
        loadContactMessages();
    }

    async function loadStats() {
        // Simple counts via Separate Queries
        const pending = await sb.from('profiles').select('id', { count: 'exact', head: true }).eq('verification_status', 'pending');
        const reports = await sb.from('reports').select('id', { count: 'exact', head: true }).eq('status', 'open');
        const users = await sb.from('profiles').select('id', { count: 'exact', head: true });
        const listings = await sb.from('listings').select('id', { count: 'exact', head: true }).eq('is_active', true);
        const submissions = await sb.from('partner_submissions').select('id', { count: 'exact', head: true }).eq('status', 'pending');
        const messages = await sb.from('contact_messages').select('id', { count: 'exact', head: true }).eq('is_read', false);

        document.getElementById('statPending').textContent = pending.count || 0;
        document.getElementById('statReports').textContent = reports.count || 0;
        document.getElementById('statUsers').textContent = users.count || 0;
        document.getElementById('statListings').textContent = listings.count || 0;
        document.getElementById('statMessages').textContent = messages.count || 0;

        // Badges
        if (pending.count > 0) {
            const b = document.getElementById('badgeVerifications');
            b.textContent = pending.count;
            b.style.display = 'inline-block';
        }
        if (reports.count > 0) {
            const b = document.getElementById('badgeReports');
            b.textContent = reports.count;
            b.style.display = 'inline-block';
        }
        if (submissions.count > 0) {
            const b = document.getElementById('badgeSubmissions');
            b.textContent = submissions.count;
            b.style.display = 'inline-block';
        }
        if (messages.count > 0) {
            const b = document.getElementById('badgeMessages');
            b.textContent = messages.count;
            b.style.display = 'inline-block';
        }
    }

    // --- REPORTS ---
    async function loadReports() {
        const container = document.getElementById('reportsList');
        // Fetch Reports inkl. Reporter Details
        // Hinweis: Wir versuchen auch reported_user und listing zu joinen, falls Foreign Keys passen.
        // Wenn nicht, laden wir IDs und zeigen Links.
        const { data: reports, error } = await sb
            .from('reports')
            .select(`
                *,
                reporter:reporter_id(email, full_name, username)
            `)
            .eq('status', 'open')
            .order('created_at', { ascending: false });

        if (error) {
            container.innerHTML = `<p style="color:red">Fehler: ${error.message}</p>`;
            return;
        }

        if (reports.length === 0) {
            container.innerHTML = '<div class="empty-state">Keine offenen Meldungen ‚úÖ</div>';
            return;
        }

        container.innerHTML = reports.map(r => {
            const reporterName = r.reporter ? (r.reporter.full_name || r.reporter.email) : 'Unbekannt';
            const reporterEmail = r.reporter ? r.reporter.email : null;
            const date = new Date(r.created_at).toLocaleDateString('de-DE');

            // Dynamische Links basierend auf Typ
            let linksHtml = '';
            if (r.reported_type === 'listing' || r.reported_type === 'wohnung' || r.reported_type === 'gegenstand') {
                linksHtml += `<a href="listing-details.html?id=${r.reported_id}" target="_blank" class="btn-mini btn-blue">üè† Inserat ansehen</a>`;
            } else if (r.reported_type === 'user') {
                linksHtml += `<a href="public-profile.html?id=${r.reported_id}" target="_blank" class="btn-mini btn-blue">üë§ Profil ansehen</a>`;
            }

            // E-Mail Link zum Melder
            let emailLink = reporterEmail ? `<a href="mailto:${escapeHtml(reporterEmail)}?subject=Room8%20Meldung%20-%20R√ºckfrage" class="btn-mini" style="background:#10B981;color:white;">‚úâÔ∏è Melder kontaktieren</a>` : '';

            return `
                <div class="admin-card">
                    <div class="card-header">
                        <div class="card-title">üö® ${escapeHtml(r.reason)}</div>
                        <span class="status-badge status-pending">Offen</span>
                    </div>
                    <div class="info-grid">
                        <div class="info-item"><label>Melder</label><span>${escapeHtml(reporterName)}</span></div>
                        <div class="info-item"><label>Melder E-Mail</label><span>${escapeHtml(reporterEmail) || '-'}</span></div>
                        <div class="info-item"><label>Datum</label><span>${date}</span></div>
                        <div class="info-item"><label>Typ</label><span>${escapeHtml(r.reported_type)}</span></div>
                    </div>
                    <p style="background:#FFFBEB; padding:0.5rem; border-radius:4px; color:#92400E; margin: 0.5rem 0;">
                        <strong>Grund:</strong> ${escapeHtml(r.reason)}
                    </p>
                    <div class="action-bar">
                        ${linksHtml}
                        ${emailLink}
                        <button class="btn-mini btn-green" onclick="resolveReport('${r.id}')">‚úÖ Erledigt</button>
                        <button class="btn-mini btn-red" onclick="banTarget('${r.reported_id}', '${r.reported_type}')">üö´ Sperren</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    // --- VERIFICATIONS ---
    var currentVerificationFilter = 'pending';
    var allVerificationProfiles = [];

    async function loadVerifications() {
        const container = document.getElementById('verificationsList');

        // Lade alle Profile die irgendeine Art von Verifizierung haben
        const { data: profiles, error } = await sb
            .from('profiles')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) {
            container.innerHTML = `<p style="color:red">Fehler: ${error.message}</p>`;
            return;
        }

        // Filter nur Profile die Verifizierungsdaten haben
        allVerificationProfiles = (profiles || []).filter(p =>
            p.verification_status ||
            p.enrollment_certificate_url ||
            p.verification_document_url ||
            p.uni_email ||
            p.edu_email ||
            p.student_id_image_url
        );

        renderVerifications();
    }

    function renderVerifications() {
        const container = document.getElementById('verificationsList');
        let filtered = allVerificationProfiles;

        if (currentVerificationFilter !== 'all') {
            filtered = allVerificationProfiles.filter(p => (p.verification_status || 'none') === currentVerificationFilter);
        }

        if (filtered.length === 0) {
            container.innerHTML = '<div class="empty-state">Keine Verifizierungen mit diesem Status.</div>';
            return;
        }

        container.innerHTML = filtered.map(p => {
            // Pr√ºfen welche Art von Beweis vorhanden ist
            let proofHtml = 'Kein Beweis angegeben';

            if (p.verification_method === 'uni-email' && p.uni_email) {
                proofHtml = `<span style="color:#059669;">‚úÖ Uni-Mail: <strong>${escapeHtml(p.uni_email)}</strong></span>`;
            } else if (p.enrollment_certificate_url) {
                proofHtml = `<button class="btn-mini btn-blue" onclick="viewDoc('${p.enrollment_certificate_url}')">üìÑ Immatrikulationsbescheinigung √∂ffnen</button>`;
            } else if (p.verification_document_url) {
                proofHtml = `<button class="btn-mini btn-blue" onclick="viewDoc('${p.verification_document_url}')">üìÑ Hochgeladenes Dokument √∂ffnen</button>`;
            } else if (p.edu_email) {
                proofHtml = `<span style="color:#059669;">‚úÖ Edu-Mail: <strong>${escapeHtml(p.edu_email)}</strong></span>`;
            } else if (p.student_id_image_url) {
                proofHtml = `<button class="btn-mini btn-blue" onclick="viewDoc('${p.student_id_image_url}')">üéì Studentenausweis √∂ffnen</button>`;
            } else if (p.avatar_url) {
                // Fallback: Vielleicht wurde das Dokument als Avatar hochgeladen?
                proofHtml = `<button class="btn-mini btn-gray" onclick="viewDoc('${p.avatar_url}')">üì∑ Profilbild ansehen</button>`;
            }

            // Status Badge
            const status = p.verification_status || 'none';
            let statusBadge = '';
            if (status === 'pending') statusBadge = '<span class="status-badge status-pending">‚è≥ Offen</span>';
            else if (status === 'approved') statusBadge = '<span class="status-badge status-approved">‚úÖ Genehmigt</span>';
            else if (status === 'rejected') statusBadge = '<span class="status-badge status-rejected">‚ùå Abgelehnt</span>';
            else statusBadge = '<span class="status-badge" style="background:#F3F4F6;color:#6B7280;">Kein Status</span>';

            // Action Buttons je nach Status
            let actionButtons = `<a href="mailto:${escapeHtml(p.email)}?subject=Room8%20Verifizierung" class="btn-mini" style="background:#10B981;color:white;">‚úâÔ∏è E-Mail</a>`;

            if (status !== 'approved') {
                actionButtons += `<button class="btn-mini btn-green" onclick="verifyUser('${p.id}', true)" style="padding: 0.75rem 1.5rem;">‚úÖ GENEHMIGEN</button>`;
            }
            if (status !== 'rejected') {
                actionButtons += `<button class="btn-mini btn-red" onclick="verifyUser('${p.id}', false)" style="padding: 0.75rem 1.5rem;">‚ùå ABLEHNEN</button>`;
            }
            if (status === 'approved' || status === 'rejected') {
                actionButtons += `<button class="btn-mini btn-yellow" onclick="resetVerification('${p.id}')">‚Ü©Ô∏è Zur√ºcksetzen</button>`;
            }

            return `
                <div class="admin-card">
                    <div class="card-header">
                        <div class="card-title">üéì ${escapeHtml(p.full_name || p.username || 'Unbekannt')}</div>
                        ${statusBadge}
                    </div>
                    <div class="info-grid">
                        <div class="info-item"><label>E-Mail</label><span>${escapeHtml(p.email)}</span></div>
                        <div class="info-item"><label>Universit√§t</label><span>${escapeHtml(p.university) || '-'}</span></div>
                        <div class="info-item"><label>Methode</label><span>${escapeHtml(p.verification_method) || 'Dokument'}</span></div>
                        <div class="info-item"><label>ID</label><span style="font-size:0.7rem">${p.id.substring(0,8)}...</span></div>
                    </div>
                    <div style="margin: 1rem 0; padding: 0.75rem; background: #F3F4F6; border-radius: 8px;">
                        <label style="font-size: 0.75rem; color: #6b7280; display: block; margin-bottom: 0.5rem;">BEWEIS / DOKUMENT</label>
                        ${proofHtml}
                    </div>
                    <div class="action-bar">
                        ${actionButtons}
                    </div>
                </div>
            `;
        }).join('');
    }

    window.filterVerifications = (status, btn) => {
        currentVerificationFilter = status;
        document.querySelectorAll('#tab-verifications .filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderVerifications();
    };

    window.resetVerification = async (id) => {
        if (!confirm("Verifizierungsstatus zur√ºcksetzen auf 'pending'?")) return;
        await sb.from('profiles').update({
            verification_status: 'pending',
            is_verified: false,
            is_student_verified: false
        }).eq('id', id);
        Room8UI.success("Status zur√ºckgesetzt.");
        loadVerifications();
        loadStats();
    };

    // --- PARTNER SUBMISSIONS ---
    var currentSubmissionFilter = 'all';
    var allSubmissions = [];

    async function loadSubmissions() {
        const container = document.getElementById('submissionsList');
        const { data: submissions, error } = await sb
            .from('partner_submissions')
            .select('*')
            .eq('status', 'pending')
            .order('submitted_at', { ascending: false });

        if (error) {
            container.innerHTML = `<p style="color:red">Fehler: ${error.message}</p>`;
            return;
        }

        allSubmissions = submissions || [];
        renderSubmissions();
    }

    function renderSubmissions() {
        const container = document.getElementById('submissionsList');
        let filtered = allSubmissions;

        if (currentSubmissionFilter !== 'all') {
            filtered = allSubmissions.filter(s => s.submission_type === currentSubmissionFilter);
        }

        if (filtered.length === 0) {
            container.innerHTML = '<div class="empty-state">Keine offenen Einreichungen.</div>';
            return;
        }

        container.innerHTML = filtered.map(s => {
            const isJob = s.submission_type === 'job';
            const icon = isJob ? 'üíº' : 'üéüÔ∏è';
            const date = new Date(s.submitted_at).toLocaleDateString('de-DE');

            // Details basierend auf Typ
            let detailsHtml = '';
            if (isJob) {
                detailsHtml = `
                    <div class="info-item"><label>Firma</label><span>${escapeHtml(s.company_name)}</span></div>
                    <div class="info-item"><label>Typ</label><span>${escapeHtml(s.job_type)}</span></div>
                    <div class="info-item"><label>Standort</label><span>${escapeHtml(s.location || s.city)}</span></div>
                    <div class="info-item"><label>Gehalt</label><span>${escapeHtml(s.salary) || '-'}</span></div>
                `;
            } else {
                detailsHtml = `
                    <div class="info-item"><label>Gesch√§ft</label><span>${escapeHtml(s.business_name)}</span></div>
                    <div class="info-item"><label>Kategorie</label><span>${escapeHtml(s.category)}</span></div>
                    <div class="info-item"><label>Stadt</label><span>${escapeHtml(s.city)}</span></div>
                    <div class="info-item"><label>Rabatt</label><span>${escapeHtml(s.discount_value)}</span></div>
                `;
            }

            return `
                <div class="admin-card">
                    <div class="card-header">
                        <div class="card-title">${icon} ${escapeHtml(s.title)}</div>
                        <span class="status-badge status-pending">${isJob ? 'Job' : 'Coupon'}</span>
                    </div>
                    <div class="info-grid">
                        ${detailsHtml}
                        <div class="info-item"><label>Kontakt</label><span>${escapeHtml(s.contact_email)}</span></div>
                        <div class="info-item"><label>Eingereicht</label><span>${date}</span></div>
                    </div>
                    <div style="background:#F9FAFB; padding:1rem; border-radius:8px; margin:0.5rem 0;">
                        <label style="font-size:0.75rem; color:#6b7280; display:block; margin-bottom:0.5rem;">BESCHREIBUNG</label>
                        <p style="margin:0; color:#374151; font-size:0.9rem;">${escapeHtml(s.description) || 'Keine Beschreibung'}</p>
                    </div>
                    <div class="action-bar">
                        <a href="mailto:${escapeHtml(s.contact_email)}?subject=Room8%20Partner%20-%20Ihre%20Einreichung" class="btn-mini" style="background:#10B981;color:white;">‚úâÔ∏è Kontaktieren</a>
                        <button class="btn-mini btn-green" onclick="approveSubmission('${s.id}', '${s.submission_type}')" style="padding: 0.75rem 1.5rem;">‚úÖ √úBERNEHMEN</button>
                        <button class="btn-mini btn-red" onclick="rejectSubmission('${s.id}')" style="padding: 0.75rem 1.5rem;">‚ùå ABLEHNEN</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    window.filterSubmissions = (type, btn) => {
        currentSubmissionFilter = type;
        document.querySelectorAll('#tab-submissions .filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderSubmissions();
    };

    window.approveSubmission = async (id, type) => {
        if (!confirm("Einreichung √ºbernehmen und ver√∂ffentlichen?")) return;

        const submission = allSubmissions.find(s => s.id === id);
        if (!submission) return;

        try {
            const { data: { user } } = await sb.auth.getUser();

            if (type === 'job') {
                // Job in listings erstellen
                const jobData = {
                    owner_id: user.id,
                    type: 'job',
                    title: submission.title || 'Unbenannter Job',
                    description: submission.description || '',
                    city: submission.city || submission.location || 'Remote',
                    location: submission.location || submission.city || 'Remote',
                    company_name: submission.company_name || 'Unbekannt',
                    company_website: submission.company_website || null,
                    company_size: submission.company_size || null,
                    job_type: submission.job_type || 'werkstudent',
                    contract_duration: submission.contract_duration || null,
                    salary_amount: submission.salary ? parseFloat(submission.salary) : null,
                    min_hours_per_week: submission.hours ? parseInt(submission.hours) : null,
                    requirements: submission.requirements ? submission.requirements.split('\n').filter(r => r.trim()) : [],
                    benefits: submission.benefits ? submission.benefits.split('\n').filter(b => b.trim()) : [],
                    application_email: submission.application_email || submission.contact_email,
                    application_url: submission.application_url || null,
                    is_active: true
                };

                const { error: jobError } = await sb.from('listings').insert(jobData);
                if (jobError) throw jobError;

            } else if (type === 'coupon') {
                // Coupon erstellen
                const couponData = {
                    user_id: user.id,
                    business_name: submission.business_name,
                    title: submission.title,
                    category: submission.category,
                    discount_value: submission.discount_value,
                    discount_code: (submission.business_name || 'ROOM8').substring(0, 6).toUpperCase() + Math.floor(Math.random() * 100),
                    valid_until: submission.valid_until,
                    description: submission.description,
                    city: submission.city,
                    partner_data: {
                        address: submission.address,
                        zip_code: submission.zip,
                        website: submission.website,
                        phone: submission.phone,
                        opening_hours: submission.opening_hours
                    },
                    status: 'active'
                };

                const { error: couponError } = await sb.from('coupons').insert(couponData);
                if (couponError) throw couponError;
            }

            // Submission als approved markieren
            await sb.from('partner_submissions').update({
                status: 'approved',
                reviewed_at: new Date().toISOString(),
                reviewed_by: user.id
            }).eq('id', id);

            Room8UI.success("Erfolgreich √ºbernommen!");
            loadSubmissions();
            loadStats();

        } catch (err) {
            Room8UI.error("Fehler: " + err.message);
        }
    };

    window.rejectSubmission = async (id) => {
        const reason = prompt("Grund f√ºr die Ablehnung (optional):");
        if (reason === null) return; // Cancelled

        const { data: { user } } = await sb.auth.getUser();

        await sb.from('partner_submissions').update({
            status: 'rejected',
            reviewed_at: new Date().toISOString(),
            reviewed_by: user.id,
            admin_notes: reason || null
        }).eq('id', id);

        Room8UI.success("Einreichung abgelehnt.");
        loadSubmissions();
        loadStats();
    };

    // --- USERS ---
    async function loadUsers() {
        const container = document.getElementById('usersList');
        const search = document.getElementById('userSearch').value.toLowerCase();
        
        let query = sb.from('profiles').select('*').order('created_at', { ascending: false }).limit(20);
        
        const { data: users } = await query;
        
        // Client-Side Filter (einfacher f√ºr Demo)
        const filtered = users.filter(u => 
            (u.email && u.email.toLowerCase().includes(search)) || 
            (u.full_name && u.full_name.toLowerCase().includes(search))
        );

        container.innerHTML = filtered.map(u => {
            const status = u.is_banned ? 'üö´ Gesperrt' : (u.is_verified ? '‚úÖ Verifiziert' : 'Standard');
            const created = new Date(u.created_at).toLocaleDateString('de-DE');
            return `
                <div class="admin-card">
                    <div class="card-header">
                        <div class="card-title">üë§ ${escapeHtml(u.full_name || u.username || 'Kein Name')}</div>
                        <span>${status}</span>
                    </div>
                    <div class="info-grid">
                        <div class="info-item"><label>E-Mail</label><span>${escapeHtml(u.email)}</span></div>
                        <div class="info-item"><label>Stadt</label><span>${escapeHtml(u.city) || '-'}</span></div>
                        <div class="info-item"><label>Registriert</label><span>${created}</span></div>
                        <div class="info-item"><label>ID</label><span style="font-size:0.7rem">${u.id.substring(0,8)}...</span></div>
                    </div>
                    <div class="action-bar">
                        <a href="mailto:${escapeHtml(u.email)}?subject=Room8%20-%20Nachricht%20vom%20Admin" class="btn-mini" style="background:#10B981;color:white;">‚úâÔ∏è E-Mail</a>
                        <a href="public-profile.html?id=${u.id}" target="_blank" class="btn-mini btn-blue">üë§ Profil</a>
                        ${u.is_banned
                            ? `<button class="btn-mini btn-green" onclick="unbanUser('${u.id}')">Entsperren</button>`
                            : `<button class="btn-mini btn-red" onclick="banUser('${u.id}')">Sperren</button>`
                        }
                    </div>
                </div>
            `;
        }).join('');
    }

    document.getElementById('userSearch').addEventListener('input', loadUsers);

    // --- LISTINGS (nur Wohnungen & Gegenst√§nde, keine Jobs) ---
    var allListingsCache = [];

    async function loadListings() {
        const container = document.getElementById('listingsList');
        const searchInput = document.getElementById('listingSearch');
        const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : '';

        // Nur einmal laden, dann cachen
        if (allListingsCache.length === 0 || !searchTerm) {
            const { data: listings, error } = await sb
                .from('listings')
                .select('*')
                .eq('type', 'wohnung')
                .order('created_at', { ascending: false })
                .limit(100);

            if (error || !listings || listings.length === 0) {
                container.innerHTML = '<div class="empty-state">Keine Wohnungen/Gegenst√§nde vorhanden.</div>';
                return;
            }
            allListingsCache = listings;
        }

        // Filtern nach Suchbegriff
        let filtered = allListingsCache;
        if (searchTerm) {
            filtered = allListingsCache.filter(l => {
                const refCode = 'r8-' + l.id.substring(0, 6).toLowerCase();
                const title = (l.title || '').toLowerCase();
                const city = (l.city || '').toLowerCase();
                const address = (l.address_line || '').toLowerCase();

                // Suche nach Ref-Code (mit oder ohne R8- Pr√§fix)
                const searchClean = searchTerm.replace('r8-', '');

                return refCode.includes(searchTerm) ||
                       l.id.toLowerCase().includes(searchClean) ||
                       title.includes(searchTerm) ||
                       city.includes(searchTerm) ||
                       address.includes(searchTerm);
            });
        }

        if (filtered.length === 0) {
            container.innerHTML = '<div class="empty-state">Keine Ergebnisse f√ºr "' + escapeHtml(searchTerm) + '"</div>';
            return;
        }

        container.innerHTML = filtered.map(l => {
            const typeLabel = 'üè† Wohnung';
            const refCode = 'R8-' + l.id.substring(0, 6).toUpperCase();
            return `
                <div class="admin-card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${typeLabel} ${escapeHtml(l.title)}</div>
                            <div class="card-meta" style="font-family: monospace; color: #0EA5E9;">üìã ${refCode}</div>
                        </div>
                        <span class="${l.is_active ? 'status-badge status-approved' : 'status-badge status-rejected'}">${l.is_active ? 'Aktiv' : 'Inaktiv'}</span>
                    </div>
                    <div class="info-grid">
                        <div class="info-item"><label>Preis</label><span>${l.price || l.monthly_rent || '-'}‚Ç¨</span></div>
                        <div class="info-item"><label>Stadt</label><span>${escapeHtml(l.city) || '-'}</span></div>
                        <div class="info-item"><label>Adresse</label><span>${escapeHtml(l.address_line) || '-'}</span></div>
                        <div class="info-item"><label>Modus</label><span>${l.listing_mode || 'offer'}</span></div>
                    </div>
                    <div class="action-bar">
                        <a href="detail.html?id=${l.id}" target="_blank" class="btn-mini btn-blue">üëÅÔ∏è Ansehen</a>
                        <button class="btn-mini btn-gray" onclick="navigator.clipboard.writeText('${refCode}'); Room8UI.success('Referenz kopiert!')">üìã Ref kopieren</button>
                        <button class="btn-mini ${l.is_active ? 'btn-yellow' : 'btn-green'}" onclick="toggleListingActive('${l.id}', ${!l.is_active})">${l.is_active ? '‚è∏Ô∏è Deaktivieren' : '‚ñ∂Ô∏è Aktivieren'}</button>
                        <button class="btn-mini btn-red" onclick="deleteListing('${l.id}')">üóëÔ∏è L√∂schen</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Listing-Suche Event Listener
    document.getElementById('listingSearch').addEventListener('input', function() {
        loadListings();
    });

    // --- MARKTPLATZ (Gegenst√§nde) ---
    var allMarktplatzCache = [];

    async function loadMarktplatz() {
        const container = document.getElementById('marktplatzList');
        const searchInput = document.getElementById('marktplatzSearch');
        const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : '';

        if (allMarktplatzCache.length === 0 || !searchTerm) {
            const { data: items, error } = await sb
                .from('listings')
                .select('*')
                .eq('type', 'gegenstand')
                .order('created_at', { ascending: false })
                .limit(100);

            if (error || !items || items.length === 0) {
                container.innerHTML = '<div class="empty-state">Keine Marktplatz-Inserate vorhanden.</div>';
                return;
            }
            allMarktplatzCache = items;
        }

        let filtered = allMarktplatzCache;
        if (searchTerm) {
            filtered = allMarktplatzCache.filter(l => {
                const title = (l.title || '').toLowerCase();
                const city = (l.city || '').toLowerCase();
                return title.includes(searchTerm) || city.includes(searchTerm);
            });
        }

        if (filtered.length === 0) {
            container.innerHTML = '<div class="empty-state">Keine Ergebnisse f√ºr "' + escapeHtml(searchTerm) + '"</div>';
            return;
        }

        container.innerHTML = filtered.map(l => {
            const refCode = 'R8-' + l.id.substring(0, 6).toUpperCase();
            return `
                <div class="admin-card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">üì¶ ${escapeHtml(l.title)}</div>
                            <div class="card-meta" style="font-family: monospace; color: #0EA5E9;">üìã ${refCode}</div>
                        </div>
                        <span class="${l.is_active ? 'status-badge status-approved' : 'status-badge status-rejected'}">${l.is_active ? 'Aktiv' : 'Inaktiv'}</span>
                    </div>
                    <div class="info-grid">
                        <div class="info-item"><label>Preis</label><span>${l.price || '-'}‚Ç¨</span></div>
                        <div class="info-item"><label>Stadt</label><span>${escapeHtml(l.city) || '-'}</span></div>
                        <div class="info-item"><label>Modus</label><span>${l.listing_mode || 'offer'}</span></div>
                    </div>
                    <div class="action-bar">
                        <a href="detail.html?id=${l.id}" target="_blank" class="btn-mini btn-blue">üëÅÔ∏è Ansehen</a>
                        <button class="btn-mini ${l.is_active ? 'btn-yellow' : 'btn-green'}" onclick="toggleMarktplatzActive('${l.id}', ${!l.is_active})">${l.is_active ? '‚è∏Ô∏è Deaktivieren' : '‚ñ∂Ô∏è Aktivieren'}</button>
                        <button class="btn-mini btn-red" onclick="deleteMarktplatz('${l.id}')">üóëÔ∏è L√∂schen</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    document.getElementById('marktplatzSearch').addEventListener('input', function() {
        loadMarktplatz();
    });

    window.toggleMarktplatzActive = async (id, active) => {
        const { error } = await sb.from('listings').update({ is_active: active }).eq('id', id);
        if (error) {
            Room8UI.error("Fehler: " + error.message);
            return;
        }
        Room8UI.success(active ? "Inserat aktiviert" : "Inserat deaktiviert");
        allMarktplatzCache = [];
        loadMarktplatz();
    };

    window.deleteMarktplatz = async (id) => {
        if(!confirm("Inserat endg√ºltig l√∂schen?")) return;

        // Erst zugeh√∂rige Fotos l√∂schen
        await sb.from('listing_photos').delete().eq('listing_id', id);

        // Dann das Listing
        const { error, data } = await sb.from('listings').delete().eq('id', id).select();

        if (error) {
            Room8UI.error("Fehler beim L√∂schen: " + error.message);
            return;
        }

        if (!data || data.length === 0) {
            Room8UI.warning("Keine Berechtigung oder Inserat nicht gefunden");
            return;
        }

        Room8UI.success("Inserat gel√∂scht!");
        allMarktplatzCache = [];
        loadMarktplatz();
    };

    window.toggleListingActive = async (id, active) => {
        const { error } = await sb.from('listings').update({ is_active: active }).eq('id', id);
        if (error) {
            Room8UI.error("Fehler: " + error.message);
            return;
        }
        Room8UI.success(active ? "Inserat aktiviert" : "Inserat deaktiviert");
        allListingsCache = [];
        loadListings();
    };

    // --- ACTIONS ---

    window.resolveReport = async (id) => {
        if(!confirm("Meldung schlie√üen?")) return;
        await sb.from('reports').update({ status: 'resolved' }).eq('id', id);
        loadReports();
    };

    window.banUser = async (id) => {
        if(!confirm("Nutzer wirklich sperren?")) return;
        await sb.from('profiles').update({ is_banned: true }).eq('id', id);
        Room8UI.success("Gesperrt.");
        loadUsers();
    };

    window.unbanUser = async (id) => {
        await sb.from('profiles').update({ is_banned: false }).eq('id', id);
        Room8UI.success("Entsperrt.");
        loadUsers();
    };

    window.banTarget = async (id, type) => {
        if (type === 'user') return window.banUser(id);
        // Wenn Inserat gemeldet wurde, sperren wir den Besitzer
        if (type === 'listing' || type === 'wohnung' || type === 'gegenstand') {
            const { data } = await sb.from('listings').select('owner_id').eq('id', id).single();
            if(data) window.banUser(data.owner_id);
        }
    };

    window.verifyUser = async (id, approve) => {
        const action = approve ? 'genehmigen' : 'ablehnen';
        if (!confirm(`Nutzer wirklich ${action}?`)) return;

        try {
            const updates = {
                verification_status: approve ? 'approved' : 'rejected',
                is_verified: approve,
                is_student_verified: approve
            };

            const { error } = await sb.from('profiles').update(updates).eq('id', id);

            if (error) {
                console.error("Fehler:", error);
                Room8UI.error("Fehler: " + error.message);
                return;
            }

            Room8UI.success(approve ? "Nutzer verifiziert!" : "Nutzer abgelehnt.");
            loadVerifications();
            loadStats();
        } catch (err) {
            console.error("Exception:", err);
            Room8UI.error("Fehler: " + err.message);
        }
    };

    window.viewDoc = async (urlOrPath) => {
        if (!urlOrPath) {
            Room8UI.warning("Kein Dokument-Pfad vorhanden.");
            return;
        }

        console.log("viewDoc aufgerufen mit:", urlOrPath);

        // Falls es bereits eine vollst√§ndige URL ist, direkt √∂ffnen
        if (urlOrPath.startsWith('http://') || urlOrPath.startsWith('https://')) {
            window.open(urlOrPath, '_blank');
            return;
        }

        // Ansonsten versuchen wir eine Public URL oder Signed URL zu erstellen
        var buckets = ['enrollment-certificates', 'verification-documents', 'avatars', 'listing-images', 'documents', 'chat-images'];

        // Erst versuchen wir Public URLs
        for (var i = 0; i < buckets.length; i++) {
            try {
                var publicResult = sb.storage.from(buckets[i]).getPublicUrl(urlOrPath);
                if (publicResult.data && publicResult.data.publicUrl) {
                    console.log("Public URL gefunden in", buckets[i], ":", publicResult.data.publicUrl);
                    window.open(publicResult.data.publicUrl, '_blank');
                    return;
                }
            } catch (e) {
                console.log('Public URL fehlgeschlagen f√ºr ' + buckets[i], e);
            }
        }

        // Dann versuchen wir Signed URLs (f√ºr private Buckets)
        for (var i = 0; i < buckets.length; i++) {
            try {
                var signedResult = await sb.storage.from(buckets[i]).createSignedUrl(urlOrPath, 300);
                if (signedResult.data && signedResult.data.signedUrl) {
                    console.log("Signed URL gefunden in", buckets[i], ":", signedResult.data.signedUrl);
                    window.open(signedResult.data.signedUrl, '_blank');
                    return;
                }
            } catch (e) {
                console.log('Signed URL fehlgeschlagen f√ºr ' + buckets[i], e);
            }
        }

        // Falls nichts gefunden wurde, zeige den Pfad an
        Room8UI.warning("Dokument konnte nicht ge√∂ffnet werden.");
        alert("Dokument-Pfad: " + urlOrPath + "\n\nBitte pr√ºfe in Supabase Storage ob die Datei existiert.");
    };

    window.deleteListing = async (id) => {
        if(!confirm("Inserat endg√ºltig l√∂schen? Dies kann nicht r√ºckg√§ngig gemacht werden!")) return;

        console.log("Deleting listing:", id);

        // Erst zugeh√∂rige Fotos l√∂schen
        await sb.from('listing_photos').delete().eq('listing_id', id);

        // Dann das Listing selbst
        const { error, data } = await sb.from('listings').delete().eq('id', id).select();

        console.log("Delete result:", { error, data });

        if (error) {
            Room8UI.error("Fehler beim L√∂schen: " + error.message);
            return;
        }

        if (!data || data.length === 0) {
            Room8UI.warning("Keine Berechtigung oder Inserat nicht gefunden");
            return;
        }

        Room8UI.success("Inserat gel√∂scht!");
        allListingsCache = [];
        loadListings();
    };

    // --- ADMIN JOBS ---
    async function loadAdminJobs() {
        const container = document.getElementById('jobsList');
        const { data: jobs, error } = await sb
            .from('listings')
            .select('*')
            .eq('type', 'job')
            .order('created_at', { ascending: false });

        if (error) {
            container.innerHTML = `<p style="color:red">Fehler: ${error.message}</p>`;
            return;
        }

        if (!jobs || jobs.length === 0) {
            container.innerHTML = '<div class="empty-state">Keine Jobs vorhanden. <a href="job-create.html">Ersten Job erstellen</a></div>';
            return;
        }

        container.innerHTML = jobs.map(j => `
            <div class="admin-card">
                <div class="card-header">
                    <div class="card-title">üíº ${escapeHtml(j.title)}</div>
                    <span class="${j.is_active ? 'status-badge status-approved' : 'status-badge status-rejected'}">${j.is_active ? 'Aktiv' : 'Inaktiv'}</span>
                </div>
                <div class="info-grid">
                    <div class="info-item"><label>Firma</label><span>${escapeHtml(j.company_name) || '-'}</span></div>
                    <div class="info-item"><label>Typ</label><span>${escapeHtml(j.job_type) || '-'}</span></div>
                    <div class="info-item"><label>Stadt</label><span>${escapeHtml(j.city) || '-'}</span></div>
                    <div class="info-item"><label>Gehalt</label><span>${j.salary_amount ? j.salary_amount + '‚Ç¨' : '-'}</span></div>
                </div>
                <div class="action-bar">
                    <button class="btn-mini btn-blue" onclick="window.open('job-detail.html?id=${j.id}', '_blank')">üëÅÔ∏è Ansehen</button>
                    <button class="btn-mini ${j.is_active ? 'btn-yellow' : 'btn-green'}" onclick="toggleJobActive('${j.id}', ${!j.is_active})">${j.is_active ? '‚è∏Ô∏è Deaktivieren' : '‚ñ∂Ô∏è Aktivieren'}</button>
                    <button class="btn-mini btn-red" onclick="deleteJob('${j.id}')">üóëÔ∏è L√∂schen</button>
                </div>
            </div>
        `).join('');
    }

    window.toggleJobActive = async (id, active) => {
        const { error } = await sb.from('listings').update({ is_active: active }).eq('id', id);
        if (error) {
            Room8UI.error("Fehler: " + error.message);
            return;
        }
        Room8UI.success(active ? "Job aktiviert" : "Job deaktiviert");
        loadAdminJobs();
    };

    window.deleteJob = async (id) => {
        if (!confirm("Job wirklich l√∂schen?")) return;
        const { error } = await sb.from('listings').delete().eq('id', id);
        if (error) {
            Room8UI.error("Fehler: " + error.message);
            return;
        }
        Room8UI.success("Job gel√∂scht");
        loadAdminJobs();
    };

    // --- ADMIN COUPONS ---
    async function loadAdminCoupons() {
        const container = document.getElementById('couponsList');
        const { data: coupons, error } = await sb
            .from('coupons')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) {
            container.innerHTML = `<p style="color:red">Fehler: ${error.message}</p>`;
            return;
        }

        if (!coupons || coupons.length === 0) {
            container.innerHTML = '<div class="empty-state">Keine Coupons vorhanden. <a href="coupon-create.html">Ersten Coupon erstellen</a></div>';
            return;
        }

        container.innerHTML = coupons.map(c => {
            const isActive = c.status === 'active';
            return `
                <div class="admin-card">
                    <div class="card-header">
                        <div class="card-title">üéüÔ∏è ${escapeHtml(c.title)}</div>
                        <span class="${isActive ? 'status-badge status-approved' : 'status-badge status-rejected'}">${isActive ? 'Aktiv' : 'Inaktiv'}</span>
                    </div>
                    <div class="info-grid">
                        <div class="info-item"><label>Partner</label><span>${escapeHtml(c.business_name)}</span></div>
                        <div class="info-item"><label>Rabatt</label><span>${escapeHtml(c.discount_value)}</span></div>
                        <div class="info-item"><label>Code</label><span style="font-family:monospace;font-weight:bold;">${escapeHtml(c.discount_code)}</span></div>
                        <div class="info-item"><label>Stadt</label><span>${escapeHtml(c.city) || '-'}</span></div>
                    </div>
                    <div class="action-bar">
                        <button class="btn-mini ${isActive ? 'btn-yellow' : 'btn-green'}" onclick="toggleCouponActive('${c.id}', ${!isActive})">${isActive ? '‚è∏Ô∏è Deaktivieren' : '‚ñ∂Ô∏è Aktivieren'}</button>
                        <button class="btn-mini btn-red" onclick="deleteCoupon('${c.id}')">üóëÔ∏è L√∂schen</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    window.toggleCouponActive = async (id, active) => {
        const { error } = await sb.from('coupons').update({ status: active ? 'active' : 'inactive' }).eq('id', id);
        if (error) {
            Room8UI.error("Fehler: " + error.message);
            return;
        }
        Room8UI.success(active ? "Coupon aktiviert" : "Coupon deaktiviert");
        loadAdminCoupons();
    };

    window.deleteCoupon = async (id) => {
        if (!confirm("Coupon wirklich l√∂schen?")) return;
        const { error } = await sb.from('coupons').delete().eq('id', id);
        if (error) {
            Room8UI.error("Fehler: " + error.message);
            return;
        }
        Room8UI.success("Coupon gel√∂scht");
        loadAdminCoupons();
    };

    // --- CONTACT MESSAGES ---
    var currentMessageFilter = 'unread';
    var allMessages = [];

    async function loadContactMessages() {
        const container = document.getElementById('messagesList');

        const { data: messages, error } = await sb
            .from('contact_messages')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) {
            container.innerHTML = `<p style="color:red">Fehler: ${error.message}</p>`;
            return;
        }

        allMessages = messages || [];

        // Badge aktualisieren
        const unreadCount = allMessages.filter(m => !m.is_read).length;
        if (unreadCount > 0) {
            const badge = document.getElementById('badgeMessages');
            badge.textContent = unreadCount;
            badge.style.display = 'inline-block';
        }

        renderMessages();
    }

    function renderMessages() {
        const container = document.getElementById('messagesList');
        let filtered = allMessages;

        if (currentMessageFilter === 'unread') {
            filtered = allMessages.filter(m => !m.is_read);
        } else if (currentMessageFilter === 'read') {
            filtered = allMessages.filter(m => m.is_read);
        }

        if (filtered.length === 0) {
            container.innerHTML = '<div class="empty-state">Keine Nachrichten.</div>';
            return;
        }

        container.innerHTML = filtered.map(m => {
            const date = new Date(m.created_at).toLocaleString('de-DE');
            const categoryLabel = {
                'frage': 'Allgemeine Frage',
                'tech': 'Technisches Problem',
                'report': 'Meldung / Sicherheit',
                'business': 'Partner / Business'
            }[m.category] || m.category || 'Sonstiges';

            return `
                <div class="admin-card" style="${m.is_read ? 'opacity: 0.7;' : 'border-left: 4px solid #3b82f6;'}">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${m.is_read ? '' : 'üîµ '}${escapeHtml(m.name)}</div>
                            <div class="card-meta">${escapeHtml(m.email)} ‚Ä¢ ${date}</div>
                        </div>
                        <span class="status-badge" style="background: #E0E7FF; color: #3730A3;">${escapeHtml(categoryLabel)}</span>
                    </div>
                    <div style="background:#F9FAFB; padding:1rem; border-radius:8px; margin:0.5rem 0;">
                        <p style="margin:0; color:#374151; font-size:0.95rem; white-space: pre-wrap;">${escapeHtml(m.message)}</p>
                    </div>
                    <div class="action-bar">
                        <a href="mailto:${escapeHtml(m.email)}?subject=Re:%20Room8%20Support%20-%20${encodeURIComponent(categoryLabel)}" class="btn-mini" style="background:#10B981;color:white;">‚úâÔ∏è Antworten</a>
                        ${!m.is_read ? `<button class="btn-mini btn-blue" onclick="markMessageRead('${m.id}')">‚úÖ Als gelesen markieren</button>` : ''}
                        <button class="btn-mini btn-red" onclick="deleteMessage('${m.id}')">üóëÔ∏è L√∂schen</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    window.filterMessages = (filter, btn) => {
        currentMessageFilter = filter;
        document.querySelectorAll('#tab-messages .filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderMessages();
    };

    window.markMessageRead = async (id) => {
        const { error } = await sb.from('contact_messages').update({ is_read: true }).eq('id', id);
        if (error) {
            Room8UI.error("Fehler: " + error.message);
            return;
        }
        Room8UI.success("Als gelesen markiert");
        loadContactMessages();
    };

    window.deleteMessage = async (id) => {
        if (!confirm("Nachricht wirklich l√∂schen?")) return;
        const { error } = await sb.from('contact_messages').delete().eq('id', id);
        if (error) {
            Room8UI.error("Fehler: " + error.message);
            return;
        }
        Room8UI.success("Nachricht gel√∂scht");
        loadContactMessages();
    };

    window.switchTab = (tab) => {
        document.querySelectorAll('.admin-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.admin-tab').forEach(el => el.classList.remove('active'));
        
        document.getElementById(`tab-${tab}`).classList.add('active');
        // Button highlighten (einfach √ºber text match, oder sauberer mit ids)
        event.target.classList.add('active');
    }

    checkAdmin();
</script>
<script src="notificationBell.js"></script>
</body>
</html>