<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Bewertung abgeben - Room8</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .review-page-container { min-height: 100vh; background-color: var(--background-color); padding-bottom: 2rem; }
    .review-header-bar { display: flex; align-items: center; padding: 1rem 1.5rem; background: white; border-bottom: 1px solid var(--border-color); }
    .review-header-bar .back-arrow { font-size: 1.5rem; text-decoration: none; color: var(--text-color); margin-right: 1rem; }
    .review-header-bar h1 { font-size: 1.2rem; margin: 0; }
    .review-form-card { max-width: 500px; margin: 2rem auto; padding: 2rem; background: white; border-radius: var(--border-radius); box-shadow: var(--box-shadow); }
    .star-rating { display: flex; flex-direction: row-reverse; justify-content: center; gap: 0.5rem; font-size: 2.5rem; margin: 1rem 0; }
    .star-rating input { display: none; }
    .star-rating label { color: #d1d5db; cursor: pointer; transition: color 0.2s; }
    .star-rating input:checked ~ label, .star-rating label:hover, .star-rating label:hover ~ label { color: #fbbf24; }
    #review-context { text-align: center; color: var(--text-light); margin-bottom: 1.5rem; font-size: 0.9rem; }
    .seller-info-box { display: flex; align-items: center; gap: 1rem; padding: 1rem; background-color: #f9fafb; border-radius: var(--border-radius); margin-bottom: 1.5rem; }
    .seller-avatar-review { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background-color: #e5e7eb; }
    .seller-name-review { font-weight: 600; color: var(--text-color); }
  </style>
</head>
<body>
  
  <main id="review-page-container" class="review-page-container">
    <div class="review-header-bar">
      <a href="javascript:history.back()" class="back-arrow">&#8592;</a>
      <h1>Bewertung abgeben</h1>
    </div>
    
    <div id="review-content" class="review-form-card">
      <h2 style="font-size: 1.2rem; margin-bottom: 0.5rem; text-align: center;">Bewerte deine Erfahrung</h2>
      <p id="review-context">Lade...</p>
      
      <div id="seller-info-container"></div>
      
      <form id="reviewForm">
        <div class="form-group">
          <label style="text-align: center; display: block;">Deine Bewertung *</label>
          <div class="star-rating">
            <input type="radio" id="star5" name="rating" value="5" required/>
            <label for="star5">&#9733;</label>
            <input type="radio" id="star4" name="rating" value="4" />
            <label for="star4">&#9733;</label>
            <input type="radio" id="star3" name="rating" value="3" />
            <label for="star3">&#9733;</label>
            <input type="radio" id="star2" name="rating" value="2" />
            <label for="star2">&#9733;</label>
            <input type="radio" id="star1" name="rating" value="1" />
            <label for="star1">&#9733;</label>
          </div>
        </div>
        <div class="form-group" style="text-align: left;">
          <label for="comment">Kommentar (Optional)</label>
          <textarea id="comment" placeholder="Erzähl uns mehr über deine Erfahrung..." style="min-height: 120px;"></textarea>
        </div>
        <div id="form-message" style="margin-bottom: 15px; font-weight: bold; text-align: center;"></div>
        <button type="submit" class="submit-btn" style="width: 100%; background-color: #10b981;">Bewertung absenden</button>
      </form>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script>
    var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    var form = document.getElementById('reviewForm');
    var msgContainer = document.getElementById('form-message');
    var contextP = document.getElementById('review-context');
    var sellerInfoContainer = document.getElementById('seller-info-container');
    var submitBtn = form.querySelector('button[type="submit"]');
    
    var urlParams = new URLSearchParams(window.location.search);
    var listingId = urlParams.get('listingId');
    var revieweeId = urlParams.get('revieweeId');

    function setFormMessage(text, isSuccess) {
      msgContainer.textContent = text;
      msgContainer.style.color = isSuccess ? 'green' : 'red';
    }

    function loadContext() {
      if (!listingId || !revieweeId) {
        contextP.textContent = 'Fehlende Informationen für die Bewertung.';
        submitBtn.disabled = true;
        return;
      }

      supabase
        .from('listings')
        .select('title')
        .eq('id', listingId)
        .single()
        .then(function(listingResponse) {
          if (listingResponse.error) throw listingResponse.error;
          contextP.textContent = 'Transaktion für "' + listingResponse.data.title + '"';

          return supabase
            .from('profiles')
            .select('username, avatar_url')
            .eq('id', revieweeId)
            .single();
        })
        .then(function(sellerResponse) {
          if (sellerResponse.error) throw sellerResponse.error;
          var seller = sellerResponse.data;
          var sellerAvatar = seller.avatar_url || 'placeholder.png';
          
          sellerInfoContainer.innerHTML = 
            '<div class="seller-info-box">' +
              '<img src="' + sellerAvatar + '" alt="' + seller.username + '" class="seller-avatar-review" onerror="this.src=\'placeholder.png\';">' +
              '<div>' +
                '<div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 2px;">Bewertung für</div>' +
                '<a href="public-profile.html?id=' + revieweeId + '" class="seller-name-review" style="text-decoration: none; color: var(--text-color);">' + (seller.username || 'Anonym') + '</a>' +
              '</div>' +
            '</div>';
        })
        .catch(function(error) {
          console.error('Error:', error);
          contextP.textContent = 'Fehler beim Laden der Informationen.';
        });
    }

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      setFormMessage('', false);
      submitBtn.disabled = true;
      submitBtn.textContent = 'Wird gesendet...';

      supabase.auth.getUser()
        .then(function(response) {
          var user = response.data.user;
          if (!user) {
            window.location.href = 'login.html';
            throw new Error('Nicht angemeldet');
          }
          
          var ratingInput = document.querySelector('input[name="rating"]:checked');
          if (!ratingInput) {
            throw new Error('Bitte wähle eine Sternebewertung.');
          }
          
          var rating = ratingInput.value;
          var comment = document.getElementById('comment').value.trim();

          return supabase
            .from('reviews')
            .select('id')
            .eq('reviewer_id', user.id)
            .eq('reviewee_id', revieweeId)
            .eq('listing_id', listingId)
            .single()
            .then(function(existingResponse) {
              if (existingResponse.data) {
                throw new Error('Du hast diese Transaktion bereits bewertet.');
              }
              
              return supabase
                .from('reviews')
                .insert({
                  reviewer_id: user.id,
                  reviewee_id: revieweeId,
                  listing_id: listingId,
                  rating: parseInt(rating),
                  comment: comment || null
                });
            });
        })
        .then(function(result) {
          if (result && result.error) throw result.error;
          
          setFormMessage('Danke für deine Bewertung!', true);
          form.reset();
          
          setTimeout(function() { 
            window.location.href = 'public-profile.html?id=' + revieweeId; 
          }, 1500);
        })
        .catch(function(err) {
          setFormMessage('Fehler: ' + err.message, false);
          submitBtn.disabled = false;
          submitBtn.textContent = 'Bewertung absenden';
        });
    });
    
    document.addEventListener('DOMContentLoaded', loadContext);
  </script>
  
  <script src="navigation.js"></script>
  <script src="translations.js"></script>
</body>
</html>
